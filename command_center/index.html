<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Arden // Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet"/>
<!-- GridStack removed — layout handled by native CSS Grid -->
<style>
/* ═══════════════════════════════════════════════════
   VARIABLES & RESET
═══════════════════════════════════════════════════ */
:root {
  --bg-primary:    #0a0a0f;
  --bg-secondary:  #0d1117;
  --bg-panel:      #0f1520;
  --bg-panel2:     #111a28;
  --cyan:     #00f0ff;
  --magenta:  #ff00c8;
  --green:    #00ff88;
  --amber:    #ffaa00;
  --red:      #ff3355;
  --purple:   #aa88ff;
  --blue:     #4488ff;
  --text:     #c8d8f0;
  --text-dim: #4a6080;
  --border:   #1a2540;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
  --font-hud:  'Orbitron', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  width: 100%; height: 100%;
  background: var(--bg-primary);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 12px;
  overflow: hidden;
}
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 2px; }

/* ═══════════════════════════════════════════════════
   ANIMATIONS
═══════════════════════════════════════════════════ */
@keyframes spin     { to { transform: rotate(360deg); } }
@keyframes spinCCW  { to { transform: rotate(-360deg); } }
@keyframes pulse    { 0%,100%{ opacity:.3 } 50%{ opacity:1 } }
@keyframes glow-cyan   { 0%,100%{ box-shadow:0 0 8px #00f0ff44,0 0 20px #00f0ff22 } 50%{ box-shadow:0 0 16px #00f0ffaa,0 0 40px #00f0ff44 } }
@keyframes glow-magenta{ 0%,100%{ box-shadow:0 0 8px #ff00c844,0 0 20px #ff00c822 } 50%{ box-shadow:0 0 16px #ff00c8aa,0 0 40px #ff00c844 } }
@keyframes glow-green  { 0%,100%{ box-shadow:0 0 8px #00ff8844,0 0 20px #00ff8822 } 50%{ box-shadow:0 0 16px #00ff88aa,0 0 40px #00ff8844 } }
@keyframes glow-amber  { 0%,100%{ box-shadow:0 0 8px #ffaa0044,0 0 20px #ffaa0022 } 50%{ box-shadow:0 0 16px #ffaa00aa,0 0 40px #ffaa0044 } }
@keyframes glow-red    { 0%,100%{ box-shadow:0 0 8px #ff335544,0 0 20px #ff335522 } 50%{ box-shadow:0 0 16px #ff3355aa,0 0 40px #ff335544 } }
@keyframes border-flow {
  0%   { border-color: #00f0ff44; }
  25%  { border-color: #ff00c844; }
  50%  { border-color: #00ff8844; }
  75%  { border-color: #ffaa0044; }
  100% { border-color: #00f0ff44; }
}
@keyframes slide-in-right { from { transform:translateX(30px); opacity:0 } to { transform:translateX(0); opacity:1 } }
@keyframes slide-in-bottom{ from { transform:translateY(20px); opacity:0 } to { transform:translateY(0); opacity:1 } }
@keyframes fade-in { from { opacity:0 } to { opacity:1 } }
@keyframes flash-new { 0%{ background:#00f0ff22 } 100%{ background:transparent } }
@keyframes ticker-scroll { from { transform:translateX(0) } to { transform:translateX(-50%) } }
@keyframes dash-anim { from { stroke-dashoffset: 200 } to { stroke-dashoffset: 0 } }
@keyframes energy-flow { from { stroke-dashoffset: 80 } to { stroke-dashoffset: 0 } }
@keyframes type-cursor { 0%,100%{ opacity:1 } 50%{ opacity:0 } }
@keyframes gauge-fill { from { stroke-dashoffset: 251.3 } to { stroke-dashoffset: var(--dash-end); } }
@keyframes counter-inc { from { opacity:0; transform:translateY(-6px) } to { opacity:1; transform:translateY(0) } }
@keyframes node-ping { 0%{ transform:scale(1); opacity:.8 } 50%{ transform:scale(1.3); opacity:.3 } 100%{ transform:scale(1); opacity:.8 } }
@keyframes bg-scan { from { transform:translateY(-100%) } to { transform:translateY(100%) } }
@keyframes crossfade { 0%{opacity:0} 20%{opacity:1} 80%{opacity:1} 100%{opacity:0} }

/* ═══════════════════════════════════════════════════
   LAYOUT SKELETON
═══════════════════════════════════════════════════ */
#app {
  display: grid;
  grid-template-rows: 52px 1fr 42px 48px 32px;
  grid-template-columns: 1fr;
  height: 100vh;
  overflow: hidden;
}

/* ═══════════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════════ */
#header {
  grid-row: 1;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
  background: linear-gradient(90deg, #0d1117 0%, #0a0a1a 50%, #0d1117 100%);
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  z-index: 20;
}
#header::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--cyan), var(--magenta), var(--cyan), transparent);
  animation: pulse 3s ease-in-out infinite;
}
.header-title {
  font-family: var(--font-hud);
  font-size: 18px; font-weight: 900;
  letter-spacing: 3px;
  background: linear-gradient(90deg, var(--cyan), var(--magenta));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-shadow: none;
}
.header-title span { color: var(--text-dim); -webkit-text-fill-color: var(--text-dim); }
.header-center { display:flex; gap:16px; align-items:center; }
.provider-badge {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 20px;
  border: 1px solid;
  font-size: 11px; font-weight: 600; letter-spacing: 1px;
  cursor: default; position: relative; overflow: hidden;
}
.provider-badge .dot {
  width: 7px; height: 7px; border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}
.pb-openrouter { border-color: #ffaa0055; color: var(--amber); }
.pb-openrouter .dot { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
.pb-openai { border-color: #00f0ff55; color: var(--cyan); }
.pb-openai .dot { background: var(--cyan); box-shadow: 0 0 6px var(--cyan); }
.pb-anthropic { border-color: #ff00c855; color: var(--magenta); }
.pb-anthropic .dot { background: var(--magenta); box-shadow: 0 0 6px var(--magenta); }
.header-right { display:flex; align-items:center; gap:14px; }
.header-clock {
  font-family: var(--font-hud); font-size: 14px;
  color: var(--cyan); letter-spacing: 2px;
  text-shadow: 0 0 10px var(--cyan);
}
.ws-indicator {
  display:flex; align-items:center; gap:5px;
  font-size: 10px; color: var(--text-dim);
}
.ws-dot {
  width:8px; height:8px; border-radius:50%;
  background: var(--red); transition: background .3s;
}
.ws-dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }

/* ═══════════════════════════════════════════════════
   MAIN BODY
═══════════════════════════════════════════════════ */
#body {
  grid-row: 2;
  overflow: hidden;
}
#dashboard { height: 100%; }

/* ═══════════════════════════════════════════════════
   AVATAR PANEL (movable GridStack tile)
═══════════════════════════════════════════════════ */
#avatar-panel {
  background: var(--bg-secondary);
  display: flex; flex-direction: column;
  overflow-y: auto; overflow-x: hidden;
  position: relative;
  height: 100%;
  border-radius: 6px;
}
#avatar-panel .panel-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}
.avatar-container {
  position: relative; width: 100%;
  padding: 20px; padding-bottom: 8px;
  display: flex; flex-direction: column; align-items: center;
}
.avatar-frame {
  position: relative;
  width: 220px; height: 220px;
}
.avatar-img-wrap {
  position: absolute; inset: 20px;
  border-radius: 50%; overflow: hidden;
  background: #0a1020;
}
.avatar-img {
  width: 100%; height: 100%;
  object-fit: cover; object-position: top center;
  border-radius: 50%;
  transition: opacity 1.2s ease-in-out;
  position: absolute; top:0; left:0;
}
.avatar-img.fade-out { opacity: 0; }
/* HUD rings */
.hud-ring {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 50%;
  border: 2px solid transparent;
  pointer-events: none;
}
.hud-ring-1 {
  border-top-color: var(--cyan);
  border-right-color: transparent;
  border-bottom-color: transparent;
  border-left-color: var(--cyan);
  animation: spin 8s linear infinite;
  box-shadow: 0 0 12px var(--cyan);
}
.hud-ring-2 {
  inset: 6px;
  border-top-color: transparent;
  border-right-color: var(--magenta);
  border-bottom-color: var(--magenta);
  border-left-color: transparent;
  animation: spinCCW 12s linear infinite;
  box-shadow: 0 0 8px var(--magenta);
}
.hud-ring-3 {
  inset: 12px;
  border-top-color: var(--green);
  border-right-color: transparent;
  border-bottom-color: var(--green);
  border-left-color: transparent;
  animation: spin 20s linear infinite;
  opacity: 0.6;
}
/* Corner brackets */
.bracket {
  position: absolute;
  width: 18px; height: 18px;
  border-color: var(--cyan);
  border-style: solid;
  pointer-events: none;
}
.bracket-tl { top: 8px; left: 8px; border-width: 2px 0 0 2px; }
.bracket-tr { top: 8px; right: 8px; border-width: 2px 2px 0 0; }
.bracket-bl { bottom: 8px; left: 8px; border-width: 0 0 2px 2px; }
.bracket-br { bottom: 8px; right: 8px; border-width: 0 2px 2px 0; }
/* Scan line */
.avatar-scan {
  position: absolute; inset: 20px;
  border-radius: 50%; overflow: hidden;
  pointer-events: none;
}
.avatar-scan::after {
  content:'';
  position: absolute; left:0; right:0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan)44, transparent);
  animation: bg-scan 3s linear infinite;
  top: 0;
}
.avatar-name {
  font-family: var(--font-hud);
  font-size: 13px; font-weight: 700;
  color: var(--cyan); letter-spacing: 2px;
  margin-top: 12px; text-align: center;
  text-shadow: 0 0 12px var(--cyan);
}
.avatar-name::after {
  content: '█';
  animation: type-cursor 1.2s step-end infinite;
  color: var(--magenta);
  font-size: 12px;
}
.avatar-role {
  font-size: 9px; color: var(--text-dim);
  letter-spacing: 3px; text-align: center;
  margin-top: 3px; text-transform: uppercase;
}
.avatar-mood-bar {
  width: 90%; margin: 10px auto 0;
  height: 3px;
  border-radius: 2px;
  background: #1a2540;
  overflow: hidden;
  position: relative;
}
.avatar-mood-fill {
  height: 100%; border-radius: 2px;
  background: var(--green);
  transition: width .5s ease, background .5s ease;
  box-shadow: 0 0 8px currentColor;
}
/* Side stats in avatar panel */
.avatar-stats { padding: 0 16px 8px; display: flex; flex-direction: column; gap: 6px; }
.avatar-stat-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 5px 10px;
  background: #0a1020;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 11px;
}
.stat-label { color: var(--text-dim); letter-spacing: 1px; }
.stat-val { font-weight: 600; font-size: 12px; }
.c-green { color: var(--green); text-shadow: 0 0 8px var(--green); }
.c-amber { color: var(--amber); text-shadow: 0 0 8px var(--amber); }
.c-red   { color: var(--red);   text-shadow: 0 0 8px var(--red); }
.c-cyan  { color: var(--cyan);  text-shadow: 0 0 8px var(--cyan); }
.c-magenta { color: var(--magenta); text-shadow: 0 0 8px var(--magenta); }
.c-purple  { color: var(--purple); text-shadow: 0 0 8px var(--purple); }
.c-dim { color: var(--text-dim); }

/* ═══════════════════════════════════════════════════
   DASHBOARD GRID (GridStack)
═══════════════════════════════════════════════════ */
#dashboard {
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
  flex: 1;
}
/* ══ NATIVE CSS GRID LAYOUT — replaces GridStack entirely ════════
   Zero JavaScript for layout = zero ghost tiles, zero artifacts.
   Each tile is targeted by its data-gs-id attribute.
   Grid: 12 equal columns, 55px auto-rows, 6px gap.
   ═══════════════════════════════════════════════════════════════ */
.grid-stack {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  grid-auto-rows: 55px;
  gap: 6px;
  padding: 6px;
  background: transparent;
  box-sizing: border-box;
}

/* Each grid-stack-item is now a normal grid child (not absolutely positioned) */
.grid-stack-item {
  position: static;
  width: auto;
  height: auto;
  transform: none;
  min-height: 0;
  min-width: 0;
}

/* Content wrapper fills the full cell height */
.grid-stack-item-content {
  height: 100%;
  overflow: hidden;
  border-radius: 6px;
}

/* ── TILE POSITIONS (CSS Grid column/row spans) ──────────────────
   Formula: grid-column: (x+1) / (x+w+1)
            grid-row:    (y+1) / (y+h+1)
   ──────────────────────────────────────────────────────────────── */

/* ─ STATUS SECTION (rows 1–12) ─ */
[data-gs-id="avatar"]    { grid-column: 1/4;   grid-row: 1/13;  } /* w=3 h=12 */
[data-gs-id="syshealth"] { grid-column: 4/7;   grid-row: 1/8;   } /* w=3 h=7  */
[data-gs-id="routing"]   { grid-column: 7/13;  grid-row: 1/6;   } /* w=6 h=5  */
[data-gs-id="budget"]    { grid-column: 7/10;  grid-row: 6/13;  } /* w=3 h=7  */
[data-gs-id="crons"]     { grid-column: 10/13; grid-row: 6/13;  } /* w=3 h=7  */
[data-gs-id="providers"] { grid-column: 4/7;   grid-row: 8/13;  } /* w=3 h=5  */

/* ─ MEDIA SECTION (rows 13–19) ─ */
[data-gs-id="giphy"]     { grid-column: 1/4;   grid-row: 13/20; } /* w=3 h=7  */
[data-gs-id="media"]     { grid-column: 4/13;  grid-row: 13/20; } /* w=9 h=7  */

/* ─ OPS SECTION (rows 20–24) ─ */
[data-gs-id="agents"]    { grid-column: 1/6;   grid-row: 20/25; } /* w=5 h=5  */
[data-gs-id="logs"]      { grid-column: 6/10;  grid-row: 20/25; } /* w=4 h=5  */
[data-gs-id="lmstudio"]  { grid-column: 10/13; grid-row: 20/25; } /* w=3 h=5  */

/* ─ COMMS SECTION (rows 25–28) — widened to fill row ─ */
[data-gs-id="telegram"]  { grid-column: 1/7;   grid-row: 25/29; } /* w=6 h=4  */
[data-gs-id="upload"]    { grid-column: 7/13;  grid-row: 25/29; } /* w=6 h=4  */

/* ─ CONTENT STRIP (rows 29–45) ─ */
[data-gs-id="notes"]     { grid-column: 1/13;  grid-row: 29/33; } /* w=12 h=4 */
[data-gs-id="shortcuts"] { grid-column: 1/13;  grid-row: 33/37; } /* w=12 h=4 */
[data-gs-id="chat"]      { grid-column: 1/7;   grid-row: 37/46; } /* w=6 h=9  */
.grid-stack-item-content > .panel {
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin: 0;
}
.grid-stack-item-content > .panel .routing-list,
.grid-stack-item-content > .panel .log-stream,
.grid-stack-item-content > .panel .cron-list,
.grid-stack-item-content > .panel .agent-list {
  flex: 1;
  overflow-y: auto;
  max-height: none;
}
.panel-header { cursor: grab; user-select: none; }
.panel-header:active { cursor: grabbing; }
/* Reset Layout button */
.reset-layout-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  cursor: pointer;
  padding: 3px 10px;
  border-radius: 3px;
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1px;
  transition: all .2s;
}
.reset-layout-btn:hover { border-color: var(--cyan)66; color: var(--cyan); }
/* Legacy span classes (no-op now, GridStack handles widths) */
.span2, .span3 { }

/* ═══════════════════════════════════════════════════
   PANEL CARD
═══════════════════════════════════════════════════ */
.panel {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px;
  position: relative;
  overflow: hidden;
  animation: fade-in .4s ease;
}
.panel::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, var(--cyan)66, transparent);
}
.panel-active {
  animation: border-flow 6s linear infinite;
  border-color: var(--cyan);
}
.panel-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom: 8px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.panel-title {
  font-family: var(--font-hud);
  font-size: 10px; font-weight: 700;
  letter-spacing: 2px; color: var(--cyan);
  text-shadow: 0 0 8px var(--cyan);
}
.panel-icon { font-size: 14px; opacity: .7; }
.panel-badge {
  font-size: 9px; padding: 1px 6px;
  border-radius: 10px;
  border: 1px solid;
  font-weight: 600; letter-spacing: 1px;
}

/* ═══════════════════════════════════════════════════
   PANEL 1: SYSTEM HEALTH
═══════════════════════════════════════════════════ */
.system-gauges {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; margin-bottom: 8px;
}
.gauge-wrap {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.gauge-ring {
  position: relative; width: 64px; height: 64px;
}
.gauge-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.gauge-bg { stroke: #1a2540; fill: none; }
.gauge-fill {
  fill: none;
  stroke-linecap: round;
  transition: stroke-dashoffset .6s ease, stroke .3s;
  stroke: var(--green);
}
.gauge-center {
  position: absolute; top:50%; left:50%;
  transform: translate(-50%,-50%);
  font-family: var(--font-hud);
  font-size: 13px; font-weight: 700;
  text-align: center; line-height: 1;
}
.gauge-label {
  font-size: 9px; color: var(--text-dim);
  letter-spacing: 1px; text-align: center;
}
.system-network {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 6px;
}
.net-row {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 4px; padding: 5px 8px;
  display: flex; justify-content: space-between; align-items: center;
}
.net-label { font-size: 9px; color: var(--text-dim); }
.net-val { font-size: 11px; font-weight: 600; color: var(--cyan); }
.disk-list { margin-top: 6px; display: flex; flex-direction: column; gap: 3px; }
.disk-row { display: flex; flex-direction: column; gap: 2px; }
.disk-info { display: flex; justify-content: space-between; font-size: 10px; }
.disk-bar-bg { height: 3px; background: #1a2540; border-radius: 2px; overflow: hidden; }
.disk-bar { height: 100%; border-radius: 2px; transition: width .5s ease; }

/* ═══════════════════════════════════════════════════
   PANEL 2: MODEL ROUTING MONITOR
═══════════════════════════════════════════════════ */
.routing-list {
  max-height: 200px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 2px;
}
.routing-entry {
  display: grid;
  grid-template-columns: 90px 1fr auto auto;
  gap: 4px; align-items: center;
  padding: 4px 6px;
  background: #0a1020;
  border-radius: 3px;
  border-left: 2px solid transparent;
  font-size: 10px;
  animation: flash-new .8s ease;
}
.routing-ts { color: var(--text-dim); font-size: 9px; }
.routing-model { color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.routing-tokens { color: var(--text-dim); font-size: 9px; }
.routing-cost { font-weight: 600; font-size: 10px; }
.provider-local    { border-left-color: var(--green) !important; }
.provider-anthropic{ border-left-color: var(--magenta) !important; }
.provider-openai   { border-left-color: var(--cyan) !important; }
.provider-openrouter{ border-left-color: var(--amber) !important; }

/* ═══════════════════════════════════════════════════
   PANEL 3: PROVIDER STATUS NODES
═══════════════════════════════════════════════════ */
.provider-viz {
  /* CSS Grid — never overlaps regardless of tile size */
  display: grid;
  grid-template-areas:
    "or  .    oa"
    ".   core  ."
    "an  .    lc";
  grid-template-columns: 1fr 86px 1fr;
  grid-template-rows:    1fr 86px 1fr;
  align-items: center;
  justify-items: center;
  gap: 2px;
  padding: 4px;
  flex: 1;
  min-height: 0;
  position: relative;
}
.energy-svg {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
}
.energy-line {
  stroke-width: 1.5;
  fill: none;
  opacity: .6;
  stroke-dasharray: 6 4;
  animation: energy-flow 1.5s linear infinite;
}
.router-core {
  grid-area: core;
  z-index: 5; position: relative;
  width: 80px; height: 80px;
  border-radius: 50%;
  background: radial-gradient(circle, #1a2a4a 0%, #0a1020 70%);
  border: 2px solid var(--cyan);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  animation: glow-cyan 3s ease-in-out infinite;
}
.router-core-label {
  font-family: var(--font-hud);
  font-size: 8px; font-weight: 700;
  color: var(--cyan); letter-spacing: 1px;
  text-align: center;
}
.router-core-active {
  font-size: 8px; color: var(--text-dim);
  margin-top: 2px;
}
/* provider-nodes-grid is now just a fragment wrapper — no layout needed */
.provider-nodes-grid { display: contents; }
.pnode {
  /* No absolute positioning — lives in the CSS grid */
  position: relative;
  width: 70px; height: 70px;
  border-radius: 50%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: #0a1020;
  border: 2px solid transparent;
  cursor: default;
  transition: all .3s;
  z-index: 2;
}
.pnode-label { font-size: 8px; font-weight: 700; letter-spacing: 1px; text-align: center; line-height: 1.2; }
.pnode-cost  { font-size: 8px; margin-top: 2px; }
.pnode-calls { font-size: 7px; color: var(--text-dim); }
.pnode.active { animation: node-ping 2s ease-in-out infinite; }
/* Grid area assignments — no more absolute pixels */
.pnode-openrouter { grid-area: or;   border-color: var(--amber); }
.pnode-openrouter .pnode-label { color: var(--amber); }
.pnode-openrouter.active { box-shadow: 0 0 16px var(--amber)66; }
.pnode-openai     { grid-area: oa;   border-color: var(--cyan); }
.pnode-openai .pnode-label { color: var(--cyan); }
.pnode-openai.active { box-shadow: 0 0 16px var(--cyan)66; }
.pnode-anthropic  { grid-area: an;   border-color: var(--magenta); }
.pnode-anthropic .pnode-label { color: var(--magenta); }
.pnode-anthropic.active { box-shadow: 0 0 16px var(--magenta)66; }
.pnode-local      { grid-area: lc;   border-color: var(--green); width: 64px; height: 64px; }
.pnode-local .pnode-label { color: var(--green); }
.pnode-local.active { box-shadow: 0 0 16px var(--green)66; }
.pnode-inactive { opacity: .35; filter: grayscale(0.7); }

/* ═══════════════════════════════════════════════════
   PANEL 4: BUDGET TRACKER
═══════════════════════════════════════════════════ */
.budget-layout {
  display: grid; grid-template-columns: 140px 1fr;
  gap: 12px; align-items: start;
}
.budget-gauge { position: relative; width: 140px; height: 140px; }
.budget-gauge svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.budget-center {
  position: absolute; top:50%; left:50%;
  transform: translate(-50%,-50%);
  text-align: center;
}
.budget-pct {
  font-family: var(--font-hud);
  font-size: 22px; font-weight: 900;
  color: var(--green);
  line-height: 1;
}
.budget-label { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; }
.budget-stats { display: flex; flex-direction: column; gap: 6px; }
.budget-row {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 4px; padding: 5px 8px;
  display: flex; justify-content: space-between; align-items: center;
}
.budget-row-label { font-size: 10px; color: var(--text-dim); letter-spacing: 1px; }
.budget-row-val { font-size: 12px; font-weight: 700; }
.budget-providers {
  margin-top: 6px; display: flex; flex-direction: column; gap: 3px;
}
.budget-provider-row { display: flex; flex-direction: column; gap: 2px; }
.budget-provider-info { display: flex; justify-content: space-between; font-size: 10px; }
.bpr-bar-bg { height: 3px; background: #1a2540; border-radius: 2px; overflow: hidden; margin-top: 1px; }
.bpr-bar { height: 100%; border-radius: 2px; transition: width .5s; }

/* ═══════════════════════════════════════════════════
   PANEL 5: CRON JOB MONITOR
═══════════════════════════════════════════════════ */
.cron-list { display: flex; flex-direction: column; gap: 4px; }
.cron-row {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 4px; padding: 6px 8px;
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 6px; align-items: center;
}
.cron-row.error-border { border-color: var(--red)88; animation: glow-red 2s infinite; }
.cron-main { display: flex; flex-direction: column; gap: 2px; }
.cron-name { font-size: 11px; font-weight: 600; color: var(--text); }
.cron-schedule { font-size: 9px; color: var(--text-dim); }
.cron-last { font-size: 9px; }
.cron-badge {
  font-size: 8px; padding: 2px 6px;
  border-radius: 10px; font-weight: 700;
  letter-spacing: 1px; border: 1px solid;
}
.badge-success { color: var(--green);  border-color: var(--green)66;  background: var(--green)11; }
.badge-running { color: var(--cyan);   border-color: var(--cyan)66;   background: var(--cyan)11;  animation: pulse 1s infinite; }
.badge-failed  { color: var(--red);    border-color: var(--red)66;    background: var(--red)11; }
.badge-pending { color: var(--amber);  border-color: var(--amber)66;  background: var(--amber)11; }
.cron-trigger {
  background: none; border: 1px solid var(--cyan)44;
  color: var(--cyan); cursor: pointer; padding: 2px 6px;
  border-radius: 3px; font-size: 9px;
  font-family: var(--font-mono);
  transition: all .2s;
}
.cron-trigger:hover { background: var(--cyan)22; border-color: var(--cyan); }

/* ═══════════════════════════════════════════════════
   PANEL 6: AGENT REGISTRY
═══════════════════════════════════════════════════ */
.agent-list { display: flex; flex-direction: column; gap: 3px; }
.agent-row {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 4px; padding: 5px 8px;
  display: grid; grid-template-columns: 8px 1fr auto auto;
  gap: 8px; align-items: center;
  cursor: pointer; transition: background .2s;
  animation: slide-in-right .3s ease;
}
.agent-row:hover { background: #0f1a2a; }
.agent-row.status-error { border-color: var(--red)66; animation: glow-red 2s infinite; }
.agent-row.status-running { border-color: var(--cyan)44; }
.agent-status-dot {
  width: 8px; height: 8px; border-radius: 50%;
}
.dot-idle    { background: var(--text-dim); }
.dot-running { background: var(--cyan);    box-shadow: 0 0 6px var(--cyan); animation: pulse 1.5s infinite; }
.dot-error   { background: var(--red);     box-shadow: 0 0 6px var(--red);  animation: pulse 1s infinite; }
.agent-info { display: flex; flex-direction: column; gap: 1px; }
.agent-name { font-size: 11px; font-weight: 600; color: var(--text); }
.agent-action { font-size: 9px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
.agent-ts { font-size: 9px; color: var(--text-dim); }
.agent-expand { color: var(--text-dim); font-size: 10px; transition: transform .2s; }
.agent-logs-popup {
  display: none; margin-top: 4px; padding: 6px;
  background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 4px; max-height: 120px; overflow-y: auto;
  grid-column: 1 / -1;
}
.agent-logs-popup.open { display: block; }
.agent-log-line { font-size: 9px; color: var(--text-dim); padding: 1px 0; }

/* ═══════════════════════════════════════════════════
   PANEL 7: LIVE LOG FEED
═══════════════════════════════════════════════════ */
.log-controls {
  display: flex; gap: 6px; align-items: center;
  margin-bottom: 6px; flex-wrap: wrap;
}
.log-filter-input {
  flex: 1; min-width: 80px;
  background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono);
  font-size: 10px; padding: 3px 7px; border-radius: 3px;
  outline: none;
}
.log-filter-input:focus { border-color: var(--cyan)66; }
.log-select {
  background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono);
  font-size: 10px; padding: 3px 6px; border-radius: 3px;
  outline: none; cursor: pointer;
}
.log-btn {
  background: none; border: 1px solid var(--border);
  color: var(--text-dim); cursor: pointer; padding: 3px 8px;
  border-radius: 3px; font-size: 9px; font-family: var(--font-mono);
  transition: all .2s;
}
.log-btn:hover { border-color: var(--cyan)66; color: var(--cyan); }
.log-btn.active { border-color: var(--cyan); color: var(--cyan); background: var(--cyan)11; }
.log-stream {
  max-height: 220px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 1px;
}
.log-entry {
  display: grid;
  grid-template-columns: 70px 70px 1fr;
  gap: 6px; padding: 2px 4px;
  border-radius: 2px;
  font-size: 10px; line-height: 1.4;
  animation: slide-in-bottom .2s ease;
}
.log-entry:hover { background: #ffffff06; }
.log-ts   { color: var(--text-dim); font-size: 9px; }
.log-agent{ color: var(--purple); font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.log-msg  { color: var(--text); }
.level-INFO    { color: var(--text); }
.level-WARN    { color: var(--amber); }
.level-ERROR   { color: var(--red); }
.level-DEBUG   { color: var(--text-dim); }
.level-SUCCESS { color: var(--green); }

/* ═══════════════════════════════════════════════════
   PANEL 8: LM STUDIO
═══════════════════════════════════════════════════ */
.lm-status {
  display: flex; align-items: center; gap: 12px;
  padding: 8px;
  background: #0a1020; border-radius: 4px;
  border: 1px solid var(--border);
}
.lm-indicator {
  width: 16px; height: 16px; border-radius: 50%;
  flex-shrink: 0;
}
.lm-online  { background: var(--green); box-shadow: 0 0 10px var(--green); animation: pulse 2s infinite; }
.lm-offline { background: var(--red); }
.lm-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.lm-model { font-size: 11px; font-weight: 600; color: var(--text); }
.lm-label { font-size: 9px; color: var(--text-dim); }
.lm-badge {
  font-size: 9px; padding: 2px 8px; border-radius: 10px;
  font-weight: 700; letter-spacing: 1px;
}

/* ═══════════════════════════════════════════════════
   PANEL 9: TELEGRAM
═══════════════════════════════════════════════════ */
.telegram-layout {
  display: flex; gap: 10px; align-items: center;
}
.telegram-icon { font-size: 32px; }
.telegram-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
.tg-status-row { display: flex; align-items: center; gap: 8px; }
.tg-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--red);
}
.tg-dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }
.tg-status-text { font-size: 12px; font-weight: 700; }
.tg-stat { font-size: 10px; color: var(--text-dim); }

/* ═══════════════════════════════════════════════════
   PANEL 10: DOC DROP ZONE
═══════════════════════════════════════════════════ */
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 6px; padding: 16px;
  text-align: center; cursor: pointer;
  transition: all .2s; position: relative;
  overflow: hidden;
}
.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--cyan)88;
  background: var(--cyan)08;
}
.drop-zone input[type=file] {
  position: absolute; inset: 0;
  opacity: 0; cursor: pointer;
}
.drop-icon { font-size: 24px; margin-bottom: 4px; }
.drop-text { font-size: 10px; color: var(--text-dim); }
.upload-list { margin-top: 8px; display: flex; flex-direction: column; gap: 2px; }
.upload-item {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 3px; padding: 4px 8px;
  display: flex; justify-content: space-between; align-items: center;
  font-size: 10px; animation: slide-in-bottom .2s ease;
}
.upload-name { color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 130px; }
.upload-meta { color: var(--text-dim); font-size: 9px; }
.progress-bar-wrap { margin-top: 4px; }
.progress-bar-bg { height: 3px; background: #1a2540; border-radius: 2px; overflow: hidden; }
.progress-bar { height: 100%; background: var(--cyan); border-radius: 2px; width: 0%; transition: width .2s; }

/* ═══════════════════════════════════════════════════
   PANEL 11: QUICK NOTES
═══════════════════════════════════════════════════ */
.notes-area {
  width: 100%; min-height: 200px; max-height: none; flex: 1;
  background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono);
  font-size: 13px; line-height: 1.6;
  padding: 7px; border-radius: 4px;
  resize: vertical; outline: none;
}
.notes-area:focus { border-color: var(--cyan)66; }
.notes-status { font-size: 9px; color: var(--text-dim); margin-top: 3px; text-align: right; }

/* ═══════════════════════════════════════════════════
   QUICK LAUNCH BAR
═══════════════════════════════════════════════════ */
#quick-launch {
  grid-row: 3;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  padding: 6px 16px;
  display: flex; align-items: center; gap: 8px;
  overflow-x: auto;
}
.ql-label {
  font-family: var(--font-hud); font-size: 9px;
  color: var(--text-dim); letter-spacing: 2px;
  white-space: nowrap; flex-shrink: 0;
}
.ql-btn {
  background: none; cursor: pointer;
  padding: 4px 14px; border-radius: 3px;
  font-family: var(--font-mono); font-size: 10px; font-weight: 600;
  letter-spacing: 1px; white-space: nowrap;
  border: 1px solid; transition: all .2s;
}
.ql-btn:hover { filter: brightness(1.3); transform: translateY(-1px); box-shadow: 0 2px 8px currentColor; }
.ql-btn:active { transform: translateY(0); }

/* ═══════════════════════════════════════════════════
   COMMAND BAR
═══════════════════════════════════════════════════ */
#command-bar {
  grid-row: 4;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  padding: 0 16px;
  display: flex; align-items: center; gap: 10px;
  position: relative;
}
.cmd-prompt {
  font-family: var(--font-hud); font-size: 11px;
  color: var(--cyan); white-space: nowrap;
  text-shadow: 0 0 8px var(--cyan);
}
.cmd-input {
  flex: 1;
  background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font-mono);
  font-size: 12px;
  caret-color: var(--cyan);
}
.cmd-output {
  position: absolute; bottom: 100%; left: 0; right: 0;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  padding: 8px 16px;
  font-size: 11px; max-height: 120px; overflow-y: auto;
  display: none;
}
.cmd-output.visible { display: block; animation: slide-in-bottom .2s ease; }
.cmd-result { color: var(--green); margin-bottom: 2px; }
.cmd-error  { color: var(--red); }
.cmd-tab-complete {
  position: absolute; bottom: 100%; left: 16px;
  background: var(--bg-panel); border: 1px solid var(--border);
  border-radius: 4px; padding: 4px;
  display: none; flex-direction: column; gap: 2px;
  z-index: 100; max-height: 160px; overflow-y: auto;
}
.cmd-tab-complete.visible { display: flex; }
.tab-option {
  padding: 3px 10px; font-size: 10px; border-radius: 2px;
  cursor: pointer; color: var(--text);
}
.tab-option:hover, .tab-option.selected { background: var(--cyan)22; color: var(--cyan); }

/* ═══════════════════════════════════════════════════
   ACTIVITY TICKER (BOTTOM)
═══════════════════════════════════════════════════ */
#activity-ticker {
  grid-row: 5;
  background: #08080e;
  border-top: 1px solid var(--border);
  overflow: hidden;
  display: flex; align-items: center;
  position: relative;
}
#activity-ticker::before {
  content: 'LAST ACTIVITY';
  position: absolute; left: 0;
  background: var(--cyan);
  color: #000; font-family: var(--font-hud);
  font-size: 8px; font-weight: 900;
  padding: 0 8px; height: 100%;
  display: flex; align-items: center;
  letter-spacing: 2px; z-index: 2;
  white-space: nowrap;
}
.ticker-track {
  padding-left: 140px;
  white-space: nowrap; overflow: hidden;
}
.ticker-inner {
  display: inline-block;
  animation: ticker-scroll 30s linear infinite;
  white-space: nowrap;
}
.ticker-inner span {
  font-size: 10px; margin-right: 60px; color: var(--text-dim);
}
.ticker-inner .ticker-ts   { color: var(--cyan); }
.ticker-inner .ticker-agent{ color: var(--magenta); }
.ticker-inner .ticker-arrow{ color: var(--text-dim); margin: 0 4px; }
.ticker-inner .ticker-msg  { color: var(--text); }

/* ═══════════════════════════════════════════════════
   MISC UTILS
═══════════════════════════════════════════════════ */
.hidden { display: none !important; }
.mt4 { margin-top: 4px; }
.flex-row { display: flex; gap: 6px; align-items: center; }
.flex-col { display: flex; flex-direction: column; gap: 4px; }
.small-badge {
  font-size: 8px; padding: 1px 5px; border-radius: 8px;
  border: 1px solid; font-weight: 700;
}

/* ═══════════════════════════════════════════════════
   TODO PANEL (left sidebar)
═══════════════════════════════════════════════════ */
.todo-panel {
  margin: 8px 10px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
  flex-shrink: 0;
}
.todo-panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 5px 10px;
  background: var(--bg-panel2);
  border-bottom: 1px solid var(--border);
}
.todo-panel-title {
  font-family: var(--font-hud);
  font-size: 9px; font-weight: 700;
  color: var(--amber); letter-spacing: 2px;
  text-shadow: 0 0 8px var(--amber);
}
.todo-folder-btn {
  background: none; border: none; cursor: pointer;
  font-size: 12px; opacity: 0.6; padding: 0 2px;
  transition: opacity .2s; line-height: 1;
}
.todo-folder-btn:hover { opacity: 1; }
#todo-list {
  max-height: 280px; overflow-y: auto;
  padding: 4px;
  display: flex; flex-direction: column; gap: 3px;
}
.todo-item {
  background: #0a1020; border: 1px solid var(--border);
  border-radius: 3px; padding: 5px 8px;
  cursor: default; animation: fade-in .3s ease;
}
.todo-item.todo-done {
  opacity: 0.5; border-color: var(--green)33;
}
.todo-item-header {
  display: flex; justify-content: space-between; align-items: center; gap: 6px;
}
.todo-item-title {
  font-size: 10px; font-weight: 600; color: var(--amber);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  flex: 1;
}
.todo-done .todo-item-title {
  color: var(--green); text-decoration: line-through;
}
.todo-item-date { font-size: 8px; color: var(--text-dim); white-space: nowrap; }
.todo-item-preview {
  font-size: 9px; color: var(--text-dim);
  margin-top: 2px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.todo-empty {
  font-size: 10px; color: var(--text-dim);
  padding: 10px; text-align: center;
}

/* ═══════════════════════════════════════════════════
   GPU SECTION (NVIDIA flair)
═══════════════════════════════════════════════════ */
:root { --nvidia: #76b900; }
@keyframes gpu-scan {
  0%   { transform: translateX(-100%); opacity: 0; }
  20%  { opacity: 1; }
  80%  { opacity: 1; }
  100% { transform: translateX(100%); opacity: 0; }
}
@keyframes nvidia-pulse {
  0%,100% { box-shadow: 0 0 6px #76b90066, 0 0 14px #76b90033; }
  50%     { box-shadow: 0 0 14px #76b900cc, 0 0 28px #76b90066; }
}
.gpu-section {
  margin-top: 8px;
  border: 1px solid #76b90033;
  border-radius: 5px;
  padding: 8px 10px 6px;
  background: linear-gradient(135deg, #060e00 0%, #0a1500 50%, #060e00 100%);
  position: relative; overflow: hidden;
  animation: nvidia-pulse 3s ease-in-out infinite;
}
.gpu-section::before {
  content: '';
  position: absolute; top: 0; left: -100%; right: auto;
  width: 50%; height: 100%;
  background: linear-gradient(90deg, transparent, #76b90011, transparent);
  animation: gpu-scan 5s ease-in-out infinite;
}
.gpu-section::after {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, #76b900, transparent);
}
.gpu-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 7px;
}
.gpu-brand-badge {
  font-family: var(--font-hud);
  font-size: 9px; font-weight: 900;
  color: #76b900; letter-spacing: 1px;
  text-shadow: 0 0 10px #76b900;
  background: #76b90022; border: 1px solid #76b90066;
  padding: 1px 6px; border-radius: 3px;
  flex-shrink: 0;
}
.gpu-name-text {
  font-size: 10px; color: var(--text);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  flex: 1;
}
.gpu-bar-row {
  display: flex; align-items: center; gap: 6px;
  margin-bottom: 4px;
}
.gpu-bar-label {
  font-size: 9px; color: #76b900;
  width: 32px; flex-shrink: 0;
  letter-spacing: 1px;
}
.gpu-bar-bg {
  flex: 1; height: 5px; border-radius: 3px;
  background: #1a2a08; overflow: hidden;
}
.gpu-bar-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, #4a7a00, #76b900, #a0e020);
  box-shadow: 0 0 6px #76b90099;
  transition: width .5s ease;
}
.gpu-bar-fill.hot {
  background: linear-gradient(90deg, #b94000, #ff6600, #ffaa00);
  box-shadow: 0 0 6px #ff660099;
}
.gpu-bar-val {
  font-size: 10px; font-weight: 700; color: #76b900;
  width: 36px; text-align: right; flex-shrink: 0;
}
.gpu-stats-row {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 4px; margin-top: 5px;
}
.gpu-stat {
  background: #0a1800; border: 1px solid #76b90022;
  border-radius: 3px; padding: 3px 6px;
  display: flex; flex-direction: column; align-items: center; gap: 1px;
}
.gpu-stat-label {
  font-size: 8px; color: #76b90099; letter-spacing: 1px;
}
.gpu-stat-val {
  font-size: 11px; font-weight: 700; color: #76b900;
  text-shadow: 0 0 6px #76b900;
}

/* ═══════════════════════════════════════════════════
   SHORTCUTS PANEL
═══════════════════════════════════════════════════ */
@keyframes sc-pulse {
  0%, 100% { box-shadow: 0 0 5px var(--sc-color, #00f0ff)55; border-color: var(--sc-color, #00f0ff)33; }
  50%       { box-shadow: 0 0 14px var(--sc-color, #00f0ff), 0 0 28px var(--sc-color, #00f0ff)44; border-color: var(--sc-color, #00f0ff)bb; }
}
@keyframes sc-shine {
  0%       { left: -100%; }
  30%, 100% { left: 200%; }
}
@keyframes sc-corner-tl { 0%,100%{ opacity:.4 } 50%{ opacity:1 } }
.sc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 6px;
  padding: 4px 2px;
  overflow-y: auto;
  flex: 1;
}
.sc-card {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 5px; padding: 10px 6px;
  border: 1px solid var(--sc-color, var(--border));
  border-radius: 6px;
  background: linear-gradient(135deg, #080f1c 0%, #0b1525 100%);
  cursor: pointer; text-decoration: none;
  color: var(--text);
  position: relative; overflow: hidden;
  animation: sc-pulse 3s ease-in-out infinite;
  animation-delay: var(--sc-delay, 0s);
  transition: transform .2s ease, background .2s ease;
  min-height: 68px;
}
.sc-card:hover {
  transform: translateY(-3px) scale(1.04);
  background: linear-gradient(135deg, #0f1830 0%, #131f38 100%);
}
.sc-card::before {
  content: '';
  position: absolute; top: 0; left: -100%;
  width: 60%; height: 100%;
  background: linear-gradient(90deg, transparent, var(--sc-color, #00f0ff)11, transparent);
  animation: sc-shine 4s ease-in-out infinite;
  animation-delay: var(--sc-delay, 0s);
}
/* corner bracket tl */
.sc-card::after {
  content: '';
  position: absolute; top: 3px; left: 3px;
  width: 8px; height: 8px;
  border-top: 1px solid var(--sc-color, #00f0ff);
  border-left: 1px solid var(--sc-color, #00f0ff);
  opacity: 0.6;
  animation: sc-corner-tl 2s ease-in-out infinite;
  animation-delay: var(--sc-delay, 0s);
}
.sc-icon {
  font-size: 18px; line-height: 1;
  filter: drop-shadow(0 0 6px var(--sc-color, #00f0ff));
}
.sc-name {
  font-size: 8px; font-weight: 600;
  letter-spacing: 1px; text-align: center;
  color: var(--sc-color, var(--text));
  text-shadow: 0 0 8px var(--sc-color, transparent);
  text-transform: uppercase;
}

/* ═══════════════════════════════════════════════════
   CHAT PANEL
═══════════════════════════════════════════════════ */
.chat-controls-row {
  display: flex; gap: 6px; margin-bottom: 6px; align-items: center;
}
.chat-select {
  background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono); font-size: 10px;
  border-radius: 3px; padding: 3px 6px;
  cursor: pointer; flex: 1;
}
.chat-select:focus { outline: none; border-color: var(--cyan)66; }
.chat-messages {
  flex: 1; overflow-y: auto;
  display: flex; flex-direction: column; gap: 6px;
  padding: 4px 2px;
  min-height: 0;
}
.chat-msg {
  display: flex; flex-direction: column; gap: 2px;
  animation: slide-in-bottom .2s ease;
}
.chat-msg-label {
  font-size: 8px; letter-spacing: 2px; font-weight: 700;
  padding: 0 4px;
}
.chat-msg-user .chat-msg-label { color: var(--cyan); }
.chat-msg-ai   .chat-msg-label { color: var(--magenta); }
.chat-msg-text {
  font-size: 11px; line-height: 1.5;
  padding: 6px 10px; border-radius: 5px;
  white-space: pre-wrap; word-break: break-word;
}
.chat-msg-user .chat-msg-text {
  background: #0d1f2e; border: 1px solid var(--cyan)33;
  color: var(--text); border-radius: 0 5px 5px 5px;
}
.chat-msg-ai .chat-msg-text {
  background: #1a0d20; border: 1px solid var(--magenta)33;
  color: var(--text); border-radius: 5px 0 5px 5px;
}
.chat-input-row {
  display: flex; gap: 6px; margin-top: 6px; align-items: center;
  border-top: 1px solid var(--border); padding-top: 6px;
}
.chat-input {
  flex: 1; background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono); font-size: 11px;
  border-radius: 3px; padding: 5px 8px;
  outline: none; transition: border-color .2s;
}
.chat-input:focus { border-color: var(--cyan)88; }
.chat-btn {
  background: none; border: 1px solid var(--border);
  color: var(--text-dim); font-family: var(--font-mono); font-size: 9px;
  padding: 4px 8px; border-radius: 3px; cursor: pointer;
  letter-spacing: 1px; transition: all .2s; white-space: nowrap;
}
.chat-btn-send { border-color: var(--cyan)66; color: var(--cyan); }
.chat-btn-send:hover { background: var(--cyan)22; box-shadow: 0 0 8px var(--cyan)44; }
.chat-btn-clr:hover { border-color: var(--red)66; color: var(--red); }
.chat-provider-indicator {
  font-size: 8px; color: var(--text-dim); letter-spacing: 1px;
  padding-right: 4px; white-space: nowrap;
}
.chat-thinking {
  display: inline-block;
  animation: pulse 1s ease-in-out infinite;
  color: var(--magenta);
}

/* ═══════════════════════════════════════════════════
   CYBERPUNK WALLPAPER
═══════════════════════════════════════════════════ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: -2; pointer-events: none;
  background:
    linear-gradient(rgba(0,240,255,0.022) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,240,255,0.022) 1px, transparent 1px),
    linear-gradient(135deg, rgba(255,0,200,0.012) 1px, transparent 1px),
    radial-gradient(ellipse at 15% 35%, rgba(0,240,255,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 85% 65%, rgba(255,0,200,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 95%, rgba(0,255,136,0.05) 0%, transparent 45%),
    var(--bg-primary);
  background-size: 44px 44px, 44px 44px, 66px 66px, 100% 100%, 100% 100%, 100% 100%, 100% 100%;
  animation: wp-breathe 12s ease-in-out infinite alternate;
}
@keyframes wp-breathe {
  0%   { opacity: 0.7; }
  50%  { opacity: 1.0; }
  100% { opacity: 0.75; }
}
body::after {
  content: '';
  position: fixed; inset: 0; z-index: -1; pointer-events: none;
  background: repeating-linear-gradient(
    0deg, transparent, transparent 3px,
    rgba(0,0,0,0.04) 3px, rgba(0,0,0,0.04) 4px
  );
}

/* ═══════════════════════════════════════════════════
   ENHANCED PANEL GLOW / HOLOGRAM EFFECTS
═══════════════════════════════════════════════════ */
@keyframes hologram-sweep {
  0%   { left: -200%; }
  100% { left: 300%; }
}
@keyframes neon-border-flow {
  0%,100% { border-color: rgba(0,240,255,0.18); }
  25%     { border-color: rgba(255,0,200,0.18); }
  50%     { border-color: rgba(0,255,136,0.18); }
  75%     { border-color: rgba(255,170,0,0.18); }
}
.panel:hover {
  box-shadow: 0 0 30px rgba(0,240,255,0.07), inset 0 0 20px rgba(0,240,255,0.025);
  transition: box-shadow 0.4s ease;
}
.panel-active {
  animation: neon-border-flow 8s linear infinite;
}
.panel-active::after {
  content: '';
  position: absolute; top: 0; left: -200%;
  width: 35%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(0,240,255,0.06), transparent);
  animation: hologram-sweep 8s ease-in-out infinite;
  pointer-events: none; z-index: 0;
}
/* Corner bracket glow on active */
.panel-active .panel-header {
  position: relative;
}
.panel-active .panel-header::before {
  content: '';
  position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan)66, transparent);
  animation: pulse 4s ease-in-out infinite;
}

/* ═══════════════════════════════════════════════════
   NOTES SAVE BUTTON
═══════════════════════════════════════════════════ */
.notes-save-btn {
  background: none;
  border: 1px solid var(--green)66;
  color: var(--green);
  font-family: var(--font-mono); font-size: 9px;
  padding: 3px 10px; border-radius: 3px; cursor: pointer;
  letter-spacing: 1px; transition: all .25s; white-space: nowrap;
}
.notes-save-btn:hover { background: var(--green)22; box-shadow: 0 0 10px var(--green)44; }
.notes-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.notes-save-btn.saving { border-color: var(--amber)66; color: var(--amber); }
.notes-unsaved { color: var(--amber) !important; }

/* ═══════════════════════════════════════════════════
   SHORTCUT CARD: MEDIA WRAPPER (embed trigger)
═══════════════════════════════════════════════════ */
.sc-card-wrap {
  position: relative;
}
.sc-ext-link {
  position: absolute; top: 4px; right: 4px;
  font-size: 9px; color: var(--text-dim); text-decoration: none;
  opacity: 0; transition: opacity .2s;
  background: rgba(0,0,0,0.65); padding: 2px 4px; border-radius: 2px;
  line-height: 1; z-index: 10; letter-spacing: 0;
}
.sc-card-wrap:hover .sc-ext-link { opacity: 1; }
.sc-card-wrap .sc-card { cursor: pointer; }

/* ═══════════════════════════════════════════════════
   GIPHY PANEL
═══════════════════════════════════════════════════ */
@keyframes giphy-glow {
  0%,100% { box-shadow: 0 0 6px rgba(255,0,200,0.25), 0 0 14px rgba(255,0,200,0.1); }
  50%      { box-shadow: 0 0 16px rgba(255,0,200,0.55), 0 0 32px rgba(255,0,200,0.2); }
}
.giphy-api-row {
  display: flex; gap: 4px; margin-bottom: 5px; align-items: center;
}
.giphy-api-label { font-size: 8px; color: var(--text-dim); letter-spacing: 1px; white-space: nowrap; }
.giphy-api-input {
  flex: 1; background: #0a1020; border: 1px solid var(--border);
  color: var(--text-dim); font-family: var(--font-mono); font-size: 9px;
  padding: 2px 6px; border-radius: 3px; outline: none;
}
.giphy-search-row {
  display: flex; gap: 6px; margin-bottom: 6px; align-items: center;
}
.giphy-input {
  flex: 1; background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono); font-size: 11px;
  padding: 5px 8px; border-radius: 3px; outline: none; transition: border-color .2s;
}
.giphy-input:focus { border-color: var(--magenta)88; }
.giphy-btn {
  background: none; border: 1px solid var(--magenta)66;
  color: var(--magenta); font-family: var(--font-mono); font-size: 9px;
  padding: 4px 10px; border-radius: 3px; cursor: pointer;
  letter-spacing: 1px; white-space: nowrap; transition: all .2s;
}
.giphy-btn:hover { background: var(--magenta)22; box-shadow: 0 0 8px var(--magenta)44; }
.giphy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.giphy-featured {
  width: 100%; max-height: 95px; object-fit: contain;
  border-radius: 4px; border: 1px solid var(--magenta)44;
  margin-bottom: 6px; display: none;
  animation: giphy-glow 3s ease-in-out infinite;
  background: #000; cursor: pointer;
}
.giphy-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 3px; overflow-y: auto; flex: 1;
}
.giphy-thumb {
  width: 100%; aspect-ratio: 1; object-fit: cover;
  border-radius: 3px; cursor: pointer;
  border: 1px solid var(--border); transition: all .2s;
}
.giphy-thumb:hover { border-color: var(--magenta); transform: scale(1.04); box-shadow: 0 0 10px var(--magenta)44; }
.giphy-empty {
  font-size: 9px; color: var(--text-dim);
  padding: 10px; text-align: center; grid-column: 1 / -1; letter-spacing: 1px;
}
.giphy-clear-btn {
  background: none; border: 1px solid var(--border); color: var(--text-dim);
  font-family: var(--font-mono); font-size: 8px; padding: 2px 6px;
  border-radius: 3px; cursor: pointer; transition: all .2s;
}
.giphy-clear-btn:hover { border-color: var(--red)66; color: var(--red); }

/* ═══════════════════════════════════════════════════
   MEDIA PLAYER PANEL
═══════════════════════════════════════════════════ */
@keyframes media-standby {
  0%,100% { opacity: 0.25; }
  50%      { opacity: 0.55; }
}
.media-url-row {
  display: flex; gap: 6px; margin-bottom: 6px; align-items: center;
}
.media-input {
  flex: 1; background: #0a1020; border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono); font-size: 10px;
  padding: 4px 8px; border-radius: 3px; outline: none; transition: border-color .2s;
}
.media-input:focus { border-color: var(--cyan)88; }
.media-btn {
  background: none; border: 1px solid var(--cyan)66;
  color: var(--cyan); font-family: var(--font-mono); font-size: 9px;
  padding: 4px 10px; border-radius: 3px; cursor: pointer;
  letter-spacing: 1px; white-space: nowrap; transition: all .2s;
}
.media-btn:hover { background: var(--cyan)22; box-shadow: 0 0 8px var(--cyan)44; }
.media-quick-btns {
  display: flex; gap: 4px; margin-bottom: 6px; flex-wrap: wrap;
}
.media-quick-btn {
  background: #0a1020; border: 1px solid var(--border);
  color: var(--text-dim); font-family: var(--font-mono); font-size: 9px;
  padding: 2px 8px; border-radius: 3px; cursor: pointer; transition: all .2s;
}
.media-quick-btn:hover { border-color: var(--cyan)66; color: var(--cyan); }
.media-frame-wrap {
  flex: 1; position: relative; min-height: 0;
  border-radius: 4px; overflow: hidden;
  border: 1px solid var(--border); background: #000;
}
.media-iframe {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  border: none; display: none;
}
.media-placeholder {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; color: var(--text-dim); font-size: 10px; letter-spacing: 1px;
}
.media-placeholder-icon {
  font-size: 40px; opacity: 0.28;
  animation: media-standby 4s ease-in-out infinite;
}
.media-placeholder-hint { opacity: 0.4; font-size: 9px; }
</style>
<!-- GridStack JS removed — CSS Grid handles all positioning -->
</head>
<body>
<div id="app">

<!-- ═══ HEADER ═══════════════════════════════════════════════════════════ -->
<header id="header">
  <div class="header-title">ARDEN<span> //</span> COMMAND CENTER</div>
  <div class="header-center">
    <div class="provider-badge pb-openrouter" id="hdr-openrouter">
      <div class="dot"></div> OPENROUTER
    </div>
    <div class="provider-badge pb-openai" id="hdr-openai">
      <div class="dot"></div> OPENAI
    </div>
    <div class="provider-badge pb-anthropic" id="hdr-anthropic">
      <div class="dot"></div> ANTHROPIC
    </div>
  </div>
  <div class="header-right">
    <button class="reset-layout-btn" onclick="resetGridLayout()" title="Reset tile positions">⊞ RESET LAYOUT</button>
    <div class="header-clock" id="clock">00:00:00</div>
    <div class="ws-indicator">
      <div class="ws-dot" id="ws-dot"></div>
      <span id="ws-label">OFFLINE</span>
    </div>
  </div>
</header>

<!-- ═══ BODY ═════════════════════════════════════════════════════════════ -->
<div id="body">

<!-- ─── DASHBOARD GRID (full width, avatar is first tile) ───────────── -->
<main id="dashboard">
<div class="grid-stack">

  <!-- AVATAR PANEL (movable tile) -->
  <div class="grid-stack-item" data-gs-id="avatar" data-gs-x="0" data-gs-y="0" data-gs-w="3" data-gs-h="12">
  <div class="grid-stack-item-content">
  <div id="avatar-panel">
    <div class="panel-header">
      <span class="panel-title">◈ ARDEN</span>
      <span class="panel-badge c-cyan" style="border-color:var(--cyan)44" id="av-mood-badge">IDLE</span>
    </div>
  <div class="avatar-container">
    <div class="avatar-frame">
      <div class="avatar-img-wrap">
        <img class="avatar-img" id="avatar-img-a" alt="Arden" style="opacity:0"/>
        <img class="avatar-img fade-out" id="avatar-img-b" alt="Arden" style="opacity:0"/>
      </div>
      <div class="hud-ring hud-ring-1"></div>
      <div class="hud-ring hud-ring-2"></div>
      <div class="hud-ring hud-ring-3"></div>
      <div class="avatar-scan"></div>
      <div class="bracket bracket-tl"></div>
      <div class="bracket bracket-tr"></div>
      <div class="bracket bracket-bl"></div>
      <div class="bracket bracket-br"></div>
    </div>
    <div class="avatar-name">ARDEN</div>
    <div class="avatar-role">Master Control // Router Core</div>
    <div class="avatar-mood-bar">
      <div class="avatar-mood-fill" id="mood-bar" style="width:85%"></div>
    </div>
  </div>

  <div class="avatar-stats">
    <div class="avatar-stat-row">
      <span class="stat-label">MOOD</span>
      <span class="stat-val c-green" id="av-mood">IDLE</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">AGENTS</span>
      <span class="stat-val c-cyan" id="av-agents">0</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">CPU</span>
      <span class="stat-val" id="av-cpu">—</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">RAM</span>
      <span class="stat-val" id="av-ram">—</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">BUDGET</span>
      <span class="stat-val" id="av-budget">—</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">API CALLS</span>
      <span class="stat-val c-amber" id="av-calls">0</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">LM STUDIO</span>
      <span class="stat-val" id="av-lm">OFFLINE</span>
    </div>
    <div class="avatar-stat-row">
      <span class="stat-label">TELEGRAM</span>
      <span class="stat-val" id="av-tg">OFFLINE</span>
    </div>
  </div>

  <!-- TO-DO PANEL -->
  <div class="todo-panel">
    <div class="todo-panel-header">
      <span class="todo-panel-title">◧ TASK QUEUE</span>
      <button class="todo-folder-btn" onclick="openTasksFolder()" title="Open tasks folder">📁</button>
    </div>
    <div id="todo-list">
      <div class="todo-empty">Loading tasks...</div>
    </div>
  </div>

  </div><!-- /#avatar-panel -->
  </div></div><!-- /gs-avatar -->

  <!-- PANEL 1: SYSTEM HEALTH -->
  <div class="grid-stack-item" data-gs-id="syshealth" data-gs-x="3" data-gs-y="0" data-gs-w="3" data-gs-h="7">
  <div class="grid-stack-item-content">
  <div class="panel panel-active" id="panel-syshealth">
    <div class="panel-header">
      <span class="panel-title">⬡ SYSTEM HEALTH</span>
      <span class="panel-badge" id="syshealth-status" style="color:var(--green);border-color:var(--green)66">NOMINAL</span>
    </div>
    <div class="system-gauges" id="gauge-grid">
      <div class="gauge-wrap">
        <div class="gauge-ring">
          <svg viewBox="0 0 64 64"><circle class="gauge-bg" cx="32" cy="32" r="26" stroke-width="6"/><circle class="gauge-fill" id="cpu-gauge" cx="32" cy="32" r="26" stroke-width="6" stroke-dasharray="163.4" stroke-dashoffset="163.4"/></svg>
          <div class="gauge-center c-cyan" id="cpu-pct">0%</div>
        </div>
        <div class="gauge-label">CPU</div>
      </div>
      <div class="gauge-wrap">
        <div class="gauge-ring">
          <svg viewBox="0 0 64 64"><circle class="gauge-bg" cx="32" cy="32" r="26" stroke-width="6"/><circle class="gauge-fill" id="ram-gauge" cx="32" cy="32" r="26" stroke-width="6" stroke-dasharray="163.4" stroke-dashoffset="163.4"/></svg>
          <div class="gauge-center c-cyan" id="ram-pct">0%</div>
        </div>
        <div class="gauge-label">RAM</div>
      </div>
      <div class="gauge-wrap">
        <div class="gauge-ring">
          <svg viewBox="0 0 64 64"><circle class="gauge-bg" cx="32" cy="32" r="26" stroke-width="6"/><circle class="gauge-fill" id="swap-gauge" cx="32" cy="32" r="26" stroke-width="6" stroke-dasharray="163.4" stroke-dashoffset="163.4"/></svg>
          <div class="gauge-center c-cyan" id="swap-pct">0%</div>
        </div>
        <div class="gauge-label">SWAP</div>
      </div>
      <div class="gauge-wrap">
        <div class="gauge-ring">
          <svg viewBox="0 0 64 64"><circle class="gauge-bg" cx="32" cy="32" r="26" stroke-width="6"/><circle class="gauge-fill" id="disk0-gauge" cx="32" cy="32" r="26" stroke-width="6" stroke-dasharray="163.4" stroke-dashoffset="163.4"/></svg>
          <div class="gauge-center c-cyan" id="disk0-pct">0%</div>
        </div>
        <div class="gauge-label" id="disk0-label">DISK</div>
      </div>
    </div>
    <div class="system-network">
      <div class="net-row"><span class="net-label">↑ UPLOAD</span><span class="net-val" id="net-up">0 B/s</span></div>
      <div class="net-row"><span class="net-label">↓ DOWNLOAD</span><span class="net-val" id="net-down">0 B/s</span></div>
      <div class="net-row"><span class="net-label">RAM USED</span><span class="net-val" id="ram-used-str">—</span></div>
      <div class="net-row"><span class="net-label">RAM TOTAL</span><span class="net-val" id="ram-total-str">—</span></div>
    </div>
    <div class="disk-list" id="disk-list"></div>

    <!-- GPU SECTION — shown when nvidia-smi data available -->
    <div class="gpu-section" id="gpu-section" style="display:none">
      <div class="gpu-header">
        <span class="gpu-brand-badge">▣ NVIDIA</span>
        <span class="gpu-name-text" id="gpu-name">GeForce RTX</span>
      </div>
      <div class="gpu-bar-row">
        <span class="gpu-bar-label">UTIL</span>
        <div class="gpu-bar-bg"><div class="gpu-bar-fill" id="gpu-util-bar" style="width:0%"></div></div>
        <span class="gpu-bar-val" id="gpu-util-val">—</span>
      </div>
      <div class="gpu-bar-row">
        <span class="gpu-bar-label">VRAM</span>
        <div class="gpu-bar-bg"><div class="gpu-bar-fill" id="gpu-vram-bar" style="width:0%"></div></div>
        <span class="gpu-bar-val" id="gpu-vram-val">—</span>
      </div>
      <div class="gpu-stats-row">
        <div class="gpu-stat">
          <span class="gpu-stat-label">TEMP</span>
          <span class="gpu-stat-val" id="gpu-temp">—</span>
        </div>
        <div class="gpu-stat">
          <span class="gpu-stat-label">PWR</span>
          <span class="gpu-stat-val" id="gpu-power">—</span>
        </div>
        <div class="gpu-stat">
          <span class="gpu-stat-label">USED</span>
          <span class="gpu-stat-val" id="gpu-vram-used">—</span>
        </div>
        <div class="gpu-stat">
          <span class="gpu-stat-label">TOTAL</span>
          <span class="gpu-stat-val" id="gpu-vram-total">—</span>
        </div>
      </div>
    </div>

  </div>
  </div></div><!-- /gs-syshealth -->

  <!-- PANEL 2: MODEL ROUTING -->
  <div class="grid-stack-item" data-gs-id="routing" data-gs-x="6" data-gs-y="0" data-gs-w="6" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-routing">
    <div class="panel-header">
      <span class="panel-title">⚡ MODEL ROUTING MONITOR</span>
      <span class="panel-badge c-amber" style="border-color:var(--amber)44" id="routing-count">0 calls</span>
    </div>
    <div class="routing-list" id="routing-list"></div>
  </div>
  </div></div><!-- /gs-routing -->

  <!-- PANEL 3: PROVIDER NODES -->
  <div class="grid-stack-item" data-gs-id="providers" data-gs-x="3" data-gs-y="7" data-gs-w="3" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-providers">
    <div class="panel-header">
      <span class="panel-title">◎ PROVIDER NODES</span>
      <span class="panel-badge c-cyan" style="border-color:var(--cyan)44" id="active-provider">ROUTING</span>
    </div>
    <div class="provider-viz">
      <svg class="energy-svg" id="energy-svg" viewBox="0 0 300 200" preserveAspectRatio="none">
        <defs>
          <filter id="glow-f">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <line id="line-openrouter" class="energy-line" x1="75" y1="40" x2="150" y2="100" stroke="var(--amber)" filter="url(#glow-f)"/>
        <line id="line-openai"     class="energy-line" x1="225" y1="40" x2="150" y2="100" stroke="var(--cyan)"   filter="url(#glow-f)"/>
        <line id="line-anthropic"  class="energy-line" x1="150" y1="175" x2="150" y2="100" stroke="var(--magenta)" filter="url(#glow-f)"/>
        <line id="line-local"      class="energy-line" x1="260" y1="100" x2="150" y2="100" stroke="var(--green)"  filter="url(#glow-f)"/>
      </svg>
      <!-- Router core — grid-area:core set in CSS -->
      <div class="router-core">
        <div class="router-core-label">ROUTER<br>CORE</div>
        <div class="router-core-active" id="rc-active">—</div>
      </div>
      <!-- Provider nodes -->
      <div class="provider-nodes-grid">
        <div class="pnode pnode-openrouter active" id="pnode-openrouter">
          <div class="pnode-label">OPEN<br>ROUTER</div>
          <div class="pnode-cost c-amber" id="pn-or-cost">$0.00</div>
          <div class="pnode-calls" id="pn-or-calls">0 calls</div>
        </div>
        <div class="pnode pnode-openai" id="pnode-openai">
          <div class="pnode-label">OPEN<br>AI</div>
          <div class="pnode-cost c-cyan" id="pn-oa-cost">$0.00</div>
          <div class="pnode-calls" id="pn-oa-calls">0 calls</div>
        </div>
        <div class="pnode pnode-anthropic" id="pnode-anthropic">
          <div class="pnode-label">ANTHRO<br>PIC</div>
          <div class="pnode-cost c-magenta" id="pn-an-cost">$0.00</div>
          <div class="pnode-calls" id="pn-an-calls">0 calls</div>
        </div>
        <div class="pnode pnode-local" id="pnode-local">
          <div class="pnode-label">LOCAL<br>GPU</div>
          <div class="pnode-cost c-green" id="pn-lc-cost">FREE</div>
          <div class="pnode-calls" id="pn-lc-calls">0 calls</div>
        </div>
      </div>
    </div>
  </div>
  </div></div><!-- /gs-providers -->

  <!-- PANEL 4: BUDGET TRACKER -->
  <div class="grid-stack-item" data-gs-id="budget" data-gs-x="6" data-gs-y="5" data-gs-w="3" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-budget">
    <div class="panel-header">
      <span class="panel-title">◐ BUDGET TRACKER</span>
      <span class="panel-badge" id="budget-status-badge" style="color:var(--green);border-color:var(--green)44">NOMINAL</span>
    </div>
    <div class="budget-layout">
      <div class="budget-gauge">
        <svg viewBox="0 0 140 140" style="transform:rotate(-90deg)">
          <circle class="gauge-bg" cx="70" cy="70" r="58" stroke-width="10"/>
          <circle class="gauge-fill" id="budget-gauge-fill" cx="70" cy="70" r="58" stroke-width="10"
            stroke-dasharray="364.4" stroke-dashoffset="364.4" stroke="var(--green)"/>
        </svg>
        <div class="budget-center">
          <div class="budget-pct" id="budget-pct">0%</div>
          <div class="budget-label">USED</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px" id="budget-spent">$0.00</div>
        </div>
      </div>
      <div class="budget-stats">
        <div class="budget-row">
          <span class="budget-row-label">LIMIT</span>
          <span class="budget-row-val c-cyan" id="budget-limit">$60.00</span>
        </div>
        <div class="budget-row">
          <span class="budget-row-label">REMAINING</span>
          <span class="budget-row-val c-green" id="budget-remaining">$60.00</span>
        </div>
        <div class="budget-row">
          <span class="budget-row-label">TODAY</span>
          <span class="budget-row-val c-amber" id="budget-daily">$0.00</span>
        </div>
        <div class="budget-row">
          <span class="budget-row-label">BURN/DAY</span>
          <span class="budget-row-val" id="budget-burn">$0.00</span>
        </div>
        <div class="budget-row">
          <span class="budget-row-label">PROJECTED</span>
          <span class="budget-row-val" id="budget-projected">$0.00</span>
        </div>
      </div>
    </div>
    <div class="budget-providers" id="budget-providers"></div>
  </div>
  </div></div><!-- /gs-budget -->

  <!-- PANEL 5: CRON JOBS -->
  <div class="grid-stack-item" data-gs-id="crons" data-gs-x="9" data-gs-y="5" data-gs-w="3" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-crons">
    <div class="panel-header">
      <span class="panel-title">⏱ CRON JOB MONITOR</span>
      <span class="panel-badge c-dim" style="border-color:var(--border)" id="cron-count">0 jobs</span>
    </div>
    <div class="cron-list" id="cron-list"></div>
  </div>
  </div></div><!-- /gs-crons -->

  <!-- PANEL 6: AGENT REGISTRY -->
  <div class="grid-stack-item" data-gs-id="agents" data-gs-x="0" data-gs-y="19" data-gs-w="5" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-agents">
    <div class="panel-header">
      <span class="panel-title">◈ AGENT REGISTRY</span>
      <span class="panel-badge c-cyan" style="border-color:var(--cyan)44" id="agent-count">0 agents</span>
    </div>
    <div class="agent-list" id="agent-list"></div>
  </div>
  </div></div><!-- /gs-agents -->

  <!-- PANEL 7: LIVE LOGS -->
  <div class="grid-stack-item" data-gs-id="logs" data-gs-x="5" data-gs-y="19" data-gs-w="4" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-logs">
    <div class="panel-header">
      <span class="panel-title">▶ LIVE LOG FEED</span>
      <div class="flex-row">
        <button class="log-btn active" id="log-pause-btn" onclick="toggleLogPause()">⏸ PAUSE</button>
        <button class="log-btn" onclick="toggleLogScroll()">AUTO-SCROLL</button>
      </div>
    </div>
    <div class="log-controls">
      <select class="log-select" id="log-level-filter" onchange="applyLogFilters()">
        <option value="">ALL LEVELS</option>
        <option value="INFO">INFO</option>
        <option value="SUCCESS">SUCCESS</option>
        <option value="WARN">WARN</option>
        <option value="ERROR">ERROR</option>
        <option value="DEBUG">DEBUG</option>
      </select>
      <input class="log-filter-input" id="log-agent-filter" placeholder="Filter agent..." oninput="applyLogFilters()"/>
    </div>
    <div class="log-stream" id="log-stream"></div>
  </div>
  </div></div><!-- /gs-logs -->

  <!-- PANEL 8: LM STUDIO -->
  <div class="grid-stack-item" data-gs-id="lmstudio" data-gs-x="9" data-gs-y="19" data-gs-w="3" data-gs-h="5">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-lmstudio">
    <div class="panel-header">
      <span class="panel-title">⬛ LM STUDIO / LOCAL GPU</span>
      <span class="panel-badge" id="lm-badge" style="color:var(--red);border-color:var(--red)44">OFFLINE</span>
    </div>
    <div class="lm-status">
      <div class="lm-indicator lm-offline" id="lm-dot"></div>
      <div class="lm-info">
        <div class="lm-model" id="lm-model">No model loaded</div>
        <div class="lm-label" id="lm-url">localhost:1234</div>
      </div>
      <div class="lm-badge" id="lm-cost-badge" style="background:var(--green)11;color:var(--green);border:1px solid var(--green)44">FREE</div>
    </div>
    <div class="avatar-stat-row" style="margin-top:6px">
      <span class="stat-label">LAST CHECK</span>
      <span class="stat-val c-dim" id="lm-checked">—</span>
    </div>
    <!-- Models list -->
    <div id="lm-models-list" style="margin-top:6px;display:flex;flex-direction:column;gap:3px;max-height:60px;overflow-y:auto"></div>
    <!-- Action buttons -->
    <div style="display:flex;gap:6px;margin-top:8px">
      <button class="chat-btn" style="flex:1;border-color:var(--green)66;color:var(--green);font-size:9px"
        onclick="lmRefresh()" title="Re-check LM Studio status">↺ REFRESH</button>
      <button class="chat-btn" style="flex:1;border-color:var(--red)66;color:var(--red);font-size:9px"
        onclick="lmEject()" title="Eject current model" id="lm-eject-btn" disabled>⏏ EJECT</button>
    </div>
  </div>
  </div></div><!-- /gs-lmstudio -->

  <!-- PANEL 9: TELEGRAM -->
  <div class="grid-stack-item" data-gs-id="telegram" data-gs-x="0" data-gs-y="24" data-gs-w="3" data-gs-h="4">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-telegram">
    <div class="panel-header">
      <span class="panel-title">✈ TELEGRAM BOT</span>
      <span class="panel-badge" id="tg-badge" style="color:var(--red);border-color:var(--red)44">OFFLINE</span>
    </div>
    <div class="telegram-layout">
      <div class="telegram-icon">✈</div>
      <div class="telegram-info">
        <div class="tg-status-row">
          <div class="tg-dot" id="tg-dot"></div>
          <span class="tg-status-text" id="tg-status">DISCONNECTED</span>
        </div>
        <div class="tg-stat">Last msg: <span id="tg-last-msg">—</span></div>
        <div class="tg-stat">Messages today: <span class="c-cyan" id="tg-count">0</span></div>
      </div>
    </div>
  </div>
  </div></div><!-- /gs-telegram -->

  <!-- PANEL 10: DOC DROP ZONE -->
  <div class="grid-stack-item" data-gs-id="upload" data-gs-x="3" data-gs-y="24" data-gs-w="3" data-gs-h="4">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-upload">
    <div class="panel-header">
      <span class="panel-title">⬇ DOC DROP ZONE</span>
      <span class="panel-badge c-dim" style="border-color:var(--border)" id="upload-count">0 files</span>
    </div>
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
      <input type="file" id="file-input" multiple style="display:none" onchange="handleFileSelect(event)"/>
      <div class="drop-icon">⬇</div>
      <div class="drop-text">DROP FILES HERE or CLICK TO BROWSE</div>
      <div class="drop-text" style="margin-top:2px;font-size:9px">→ /workspace/imports/uploaded-docs/</div>
      <div class="progress-bar-wrap" id="upload-progress-wrap" style="display:none;margin-top:6px">
        <div class="progress-bar-bg"><div class="progress-bar" id="upload-progress-bar"></div></div>
      </div>
    </div>
    <div class="upload-list" id="upload-list"></div>
  </div>
  </div></div><!-- /gs-upload -->

  <!-- PANEL 11: QUICK NOTES (manual save — no autosave) -->
  <div class="grid-stack-item" data-gs-id="notes" data-gs-x="0" data-gs-y="28" data-gs-w="12" data-gs-h="4">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-notes" style="display:flex;flex-direction:column">
    <div class="panel-header">
      <span class="panel-title">✎ QUICK NOTES</span>
      <div class="flex-row" style="gap:8px">
        <span id="notes-status" style="font-size:9px;color:var(--text-dim);letter-spacing:1px">ready</span>
        <button class="notes-save-btn" id="notes-save-btn" onclick="saveNotes()">💾 SAVE</button>
      </div>
    </div>
    <textarea class="notes-area" id="notes-area" placeholder="Workspace notes — click SAVE to persist to DB + /imports/workspace-notes.md..."></textarea>
  </div>
  </div></div><!-- /gs-notes -->

  <!-- PANEL 12: SHORTCUTS (media tiles trigger pass-through player) -->
  <div class="grid-stack-item" data-gs-id="shortcuts" data-gs-x="0" data-gs-y="32" data-gs-w="12" data-gs-h="4">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-shortcuts">
    <div class="panel-header">
      <span class="panel-title">⚡ SHORTCUTS</span>
      <span class="panel-badge c-amber" style="border-color:var(--amber)44">QUICK ACCESS · MEDIA = OPEN IN PLAYER</span>
    </div>
    <div class="sc-grid">
      <!-- MEDIA: click = open in player, ↗ = new tab -->
      <div class="sc-card-wrap">
        <div class="sc-card" style="--sc-color:#FF0000;--sc-delay:0.0s" onclick="openInPlayer('https://www.youtube.com/watch?v=jfKfPfyJRdk','YouTube')">
          <a class="sc-ext-link" href="https://youtube.com" target="_blank" rel="noopener" onclick="event.stopPropagation()">↗</a>
          <span class="sc-icon">▶</span><span class="sc-name">YouTube</span>
        </div>
      </div>
      <div class="sc-card-wrap">
        <div class="sc-card" style="--sc-color:#9146FF;--sc-delay:0.2s" onclick="openInPlayer('https://player.twitch.tv/?channel=monstercat&parent=' + location.hostname,'Twitch')">
          <a class="sc-ext-link" href="https://twitch.tv" target="_blank" rel="noopener" onclick="event.stopPropagation()">↗</a>
          <span class="sc-icon">📡</span><span class="sc-name">Twitch</span>
        </div>
      </div>
      <div class="sc-card-wrap">
        <div class="sc-card" style="--sc-color:#00f2ea;--sc-delay:0.4s" onclick="openInPlayer('https://tiktok.com','TikTok')" title="TikTok (opens new tab — embeds blocked)">
          <a class="sc-ext-link" href="https://tiktok.com" target="_blank" rel="noopener" onclick="event.stopPropagation()">↗</a>
          <span class="sc-icon">🎵</span><span class="sc-name">TikTok</span>
        </div>
      </div>
      <!-- Standard links -->
      <a class="sc-card" href="https://mail.google.com" target="_blank" rel="noopener" style="--sc-color:#EA4335;--sc-delay:0.6s">
        <span class="sc-icon">✉</span><span class="sc-name">Gmail</span></a>
      <a class="sc-card" href="https://console.anthropic.com" target="_blank" rel="noopener" style="--sc-color:#D97757;--sc-delay:0.8s">
        <span class="sc-icon">◈</span><span class="sc-name">Anthropic</span></a>
      <a class="sc-card" href="https://platform.openai.com" target="_blank" rel="noopener" style="--sc-color:#10a37f;--sc-delay:1.0s">
        <span class="sc-icon">◉</span><span class="sc-name">OpenAI</span></a>
      <a class="sc-card" href="https://openrouter.ai" target="_blank" rel="noopener" style="--sc-color:#ffaa00;--sc-delay:1.2s">
        <span class="sc-icon">⟁</span><span class="sc-name">OpenRouter</span></a>
      <a class="sc-card" href="https://github.com" target="_blank" rel="noopener" style="--sc-color:#f0f6fc;--sc-delay:1.4s">
        <span class="sc-icon">⎔</span><span class="sc-name">GitHub</span></a>
      <a class="sc-card" href="https://huggingface.co" target="_blank" rel="noopener" style="--sc-color:#FFD21E;--sc-delay:1.6s">
        <span class="sc-icon">🤗</span><span class="sc-name">HuggingFace</span></a>
      <a class="sc-card" href="https://discord.com" target="_blank" rel="noopener" style="--sc-color:#5865F2;--sc-delay:1.8s">
        <span class="sc-icon">💬</span><span class="sc-name">Discord</span></a>
      <a class="sc-card" href="https://colab.research.google.com" target="_blank" rel="noopener" style="--sc-color:#F9AB00;--sc-delay:2.0s">
        <span class="sc-icon">⬡</span><span class="sc-name">Colab</span></a>
      <a class="sc-card" href="http://localhost:1234" target="_blank" rel="noopener" style="--sc-color:#00f0ff;--sc-delay:2.2s">
        <span class="sc-icon">⬛</span><span class="sc-name">LM Studio</span></a>
      <a class="sc-card" href="https://x.com" target="_blank" rel="noopener" style="--sc-color:#1DA1F2;--sc-delay:2.4s">
        <span class="sc-icon">𝕏</span><span class="sc-name">X / Twitter</span></a>
      <a class="sc-card" href="https://notion.so" target="_blank" rel="noopener" style="--sc-color:#ffffff;--sc-delay:2.6s">
        <span class="sc-icon">◧</span><span class="sc-name">Notion</span></a>
    </div>
  </div>
  </div></div><!-- /gs-shortcuts -->

  <!-- PANEL 13: AI CHAT (API key persisted in localStorage) -->
  <div class="grid-stack-item" data-gs-id="chat" data-gs-x="0" data-gs-y="36" data-gs-w="6" data-gs-h="9">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-chat" style="display:flex;flex-direction:column">
    <div class="panel-header">
      <span class="panel-title">◈ AI CHAT</span>
      <span class="panel-badge c-magenta" style="border-color:var(--magenta)44" id="chat-status-badge">READY</span>
    </div>
    <div class="chat-controls-row">
      <select class="chat-select" id="chat-provider" onchange="chatUpdateModels(); chatLoadSavedKey()" style="max-width:110px">
        <option value="anthropic">Anthropic</option>
        <option value="openrouter" selected>OpenRouter</option>
        <option value="openai">OpenAI</option>
      </select>
      <select class="chat-select" id="chat-model"></select>
    </div>
    <div class="chat-controls-row" style="gap:4px">
      <span style="font-size:9px;color:var(--text-dim);white-space:nowrap;letter-spacing:1px">API KEY</span>
      <input class="chat-input" id="chat-api-key" type="password"
        placeholder="Paste key — auto-saved per provider..."
        style="font-size:10px;padding:3px 6px;flex:1"
        oninput="chatSaveKey()"/>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-row">
      <input class="chat-input" id="chat-input" type="text"
        placeholder="Ask Arden anything..."
        autocomplete="off" spellcheck="false"
        onkeydown="if(event.key==='Enter')sendChat()"/>
      <button class="chat-btn chat-btn-send" onclick="sendChat()">▶ SEND</button>
      <button class="chat-btn chat-btn-clr" onclick="clearChat()" title="Clear chat">✕</button>
    </div>
  </div>
  </div></div><!-- /gs-chat -->

  <!-- PANEL 14: GIPHY SEARCH -->
  <div class="grid-stack-item" data-gs-id="giphy" data-gs-x="0" data-gs-y="12" data-gs-w="3" data-gs-h="7">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-giphy" style="display:flex;flex-direction:column">
    <div class="panel-header">
      <span class="panel-title">🎮 GIPHY</span>
      <div class="flex-row" style="gap:4px">
        <span class="panel-badge c-magenta" style="border-color:var(--magenta)44" id="giphy-badge">BROWSE</span>
        <button class="giphy-clear-btn" onclick="clearGiphy()">✕</button>
      </div>
    </div>
    <div class="giphy-api-row">
      <span class="giphy-api-label">KEY</span>
      <input class="giphy-api-input" id="giphy-api-key" type="password" placeholder="Paste GIPHY API key (or leave blank for demo)..."/>
    </div>
    <div class="giphy-search-row">
      <input class="giphy-input" id="giphy-search-input" type="text"
        placeholder="Search GIFs... (ADHD mode)"
        onkeydown="if(event.key==='Enter')giphySearch()"/>
      <button class="giphy-btn" id="giphy-search-btn" onclick="giphySearch()">🔍</button>
    </div>
    <img class="giphy-featured" id="giphy-featured" src="" alt="Selected GIF" title="Click to copy URL" onclick="giphyCopyUrl()"/>
    <div class="giphy-grid" id="giphy-results">
      <div class="giphy-empty">Search for GIFs above ↑<br><span style="color:var(--magenta);font-size:8px;margin-top:4px;display:block">ADHD MODE ENGAGED ⚡</span></div>
    </div>
  </div>
  </div></div><!-- /gs-giphy -->

  <!-- PANEL 15: MEDIA PASS-THROUGH PLAYER -->
  <div class="grid-stack-item" data-gs-id="media" data-gs-x="3" data-gs-y="12" data-gs-w="9" data-gs-h="7">
  <div class="grid-stack-item-content">
  <div class="panel" id="panel-media" style="display:flex;flex-direction:column">
    <div class="panel-header">
      <span class="panel-title">▶ MEDIA PLAYER</span>
      <span class="panel-badge c-cyan" style="border-color:var(--cyan)44" id="media-badge">STANDBY</span>
    </div>
    <div class="media-quick-btns">
      <button class="media-quick-btn" onclick="openInPlayer('https://www.youtube.com/watch?v=jfKfPfyJRdk','YouTube Lo-Fi')">▶ YT Lo-Fi</button>
      <button class="media-quick-btn" onclick="openInPlayer('https://player.twitch.tv/?channel=monstercat&parent=' + location.hostname,'Monstercat')">📡 Monstercat</button>
      <button class="media-quick-btn" onclick="openInPlayer('https://www.youtube.com/embed/live_stream?channel=UCiMhD4jzUqG-IgPzUmmytRQ','Stream')">🔴 Live</button>
      <button class="media-quick-btn" onclick="clearMedia()">✕ CLEAR</button>
    </div>
    <div class="media-url-row">
      <input class="media-input" id="media-url-input" type="text"
        placeholder="YouTube URL / youtu.be / Twitch channel URL / any embed URL..."
        onkeydown="if(event.key==='Enter')loadMediaFromInput()"/>
      <button class="media-btn" onclick="loadMediaFromInput()">▶ LOAD</button>
    </div>
    <div class="media-frame-wrap">
      <iframe class="media-iframe" id="media-iframe" src="about:blank"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>
      <div class="media-placeholder" id="media-placeholder">
        <div class="media-placeholder-icon">⎑</div>
        <div style="font-size:10px;opacity:0.5;letter-spacing:1px">CLICK SHORTCUTS MEDIA ICONS</div>
        <div class="media-placeholder-hint">YOUTUBE · TWITCH · ANY EMBED URL</div>
      </div>
    </div>
  </div>
  </div></div><!-- /gs-media -->

</div><!-- /.grid-stack -->
</main>
</div>

<!-- ═══ QUICK LAUNCH ══════════════════════════════════════════════════════ -->
<div id="quick-launch">
  <div class="ql-label">QUICK LAUNCH</div>
  <div id="ql-buttons"></div>
</div>

<!-- ═══ COMMAND BAR ═══════════════════════════════════════════════════════ -->
<div id="command-bar">
  <div class="cmd-prompt">ARDEN&gt;</div>
  <input class="cmd-input" id="cmd-input" type="text"
    placeholder="trigger [job] | restart [agent] | run [agent] [prompt] | clear logs | set budget [amt]"
    autocomplete="off" spellcheck="false"/>
  <div class="cmd-tab-complete" id="tab-complete"></div>
  <div class="cmd-output" id="cmd-output"></div>
</div>

<!-- ═══ ACTIVITY TICKER ════════════════════════════════════════════════════ -->
<div id="activity-ticker">
  <div class="ticker-track">
    <div class="ticker-inner" id="ticker-inner">
      <span><span class="ticker-ts">--:--:--</span><span class="ticker-arrow"> → </span><span class="ticker-agent">system</span><span class="ticker-arrow"> → </span><span class="ticker-msg">Waiting for activity...</span></span>
    </div>
  </div>
</div>

</div><!-- #app -->

<script>
// ═══════════════════════════════════════════════════════
//  GLOBALS
// ═══════════════════════════════════════════════════════
const API = '';
let ws = null;
let wsReconnectTimer = null;
let logsPaused = false;
let logsAutoScroll = true;
let cmdHistory = [];
let cmdHistoryIdx = -1;
let notesTimer = null;
let allLogs = [];
let allAgents = [];
let allCrons = [];
let allUploads = [];

// Avatar crossfade state
let avatarActive = 'a';
let avatarInitialized = false;
const imgA = document.getElementById('avatar-img-a');
const imgB = document.getElementById('avatar-img-b');

// ═══════════════════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════════════════
function fmtBytes(b) {
  if (b === null || b === undefined || isNaN(b)) return '—';
  const units = ['B','KB','MB','GB','TB'];
  let i = 0;
  while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
  return `${b.toFixed(1)} ${units[i]}`;
}
function fmtTime(iso) {
  if (!iso) return '—';
  try {
    const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
    return d.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  } catch { return '—'; }
}
function fmtRelTime(iso) {
  if (!iso) return '—';
  try {
    const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
    const diff = Math.floor((Date.now() - d.getTime()) / 1000);
    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
    return `${Math.floor(diff/86400)}d ago`;
  } catch { return '—'; }
}
function getMetricColor(pct) {
  if (pct >= 85) return 'var(--red)';
  if (pct >= 60) return 'var(--amber)';
  return 'var(--green)';
}
function getMetricClass(pct) {
  if (pct >= 85) return 'c-red';
  if (pct >= 60) return 'c-amber';
  return 'c-green';
}
function setGauge(id, pct) {
  const el = document.getElementById(id);
  if (!el) return;
  const circ = 163.4;
  const offset = circ - (circ * Math.min(100, Math.max(0, pct)) / 100);
  el.style.strokeDashoffset = offset;
  el.style.stroke = getMetricColor(pct);
}

// ═══════════════════════════════════════════════════════
//  CLOCK
// ═══════════════════════════════════════════════════════
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

// ═══════════════════════════════════════════════════════
//  WEBSOCKET
// ═══════════════════════════════════════════════════════
function connectWS() {
  const wsUrl = `ws://${location.host}/ws`;
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    document.getElementById('ws-dot').classList.add('connected');
    document.getElementById('ws-label').textContent = 'LIVE';
    clearTimeout(wsReconnectTimer);
  };
  ws.onmessage = (e) => {
    try { handleEvent(JSON.parse(e.data)); } catch {}
  };
  ws.onclose = () => {
    document.getElementById('ws-dot').classList.remove('connected');
    document.getElementById('ws-label').textContent = 'RECONNECTING';
    wsReconnectTimer = setTimeout(connectWS, 3000);
  };
  ws.onerror = () => {
    ws.close();
  };
  // Keep-alive ping
  setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping' }));
    }
  }, 15000);
}

function handleEvent(msg) {
  const { type, data } = msg;
  switch (type) {
    case 'init':
      renderAll(data);
      break;
    case 'system_metrics':
      renderSystemMetrics(data);
      break;
    case 'new_log':
      addLogEntry(data);
      break;
    case 'logs_cleared':
      allLogs = [];
      document.getElementById('log-stream').innerHTML = '';
      break;
    case 'routing_call':
      prependRoutingEntry(data);
      break;
    case 'agent_update':
      allAgents = data;
      renderAgents(data);
      updateAvatarStats(data);
      break;
    case 'budget_update':
      renderBudget(data);
      break;
    case 'cron_update':
      allCrons = data;
      renderCrons(data);
      break;
    case 'avatar_update':
      renderAvatar(data);
      break;
    case 'lmstudio_update':
      renderLMStudio(data);
      break;
    case 'telegram_update':
      renderTelegram(data);
      break;
    case 'upload_complete':
      allUploads.unshift(data);
      renderUploads(allUploads.slice(0,10));
      break;
    case 'quicklaunch_update':
      renderQuickLaunch(data);
      break;
    case 'activity_tick':
      renderTicker(data);
      break;
    case 'providers':
      renderProviderNodes(data);
      break;
    case 'tasks_update':
      renderTasks(data);
      break;
  }
}

// ═══════════════════════════════════════════════════════
//  RENDER ALL (init)
// ═══════════════════════════════════════════════════════
function renderAll(d) {
  if (d.system)      renderSystemMetrics(d.system);
  if (d.logs)        renderLogs(d.logs);
  if (d.routing)     renderRouting(d.routing);
  if (d.budget)      renderBudget(d.budget);
  if (d.crons)       { allCrons = d.crons; renderCrons(d.crons); }
  if (d.agents)      { allAgents = d.agents; renderAgents(d.agents); updateAvatarStats(d.agents); }
  if (d.avatar)      renderAvatar(d.avatar);
  if (d.lmstudio)    renderLMStudio(d.lmstudio);
  if (d.telegram)    renderTelegram(d.telegram);
  if (d.quicklaunch) renderQuickLaunch(d.quicklaunch);
  if (d.uploads)     { allUploads = d.uploads; renderUploads(d.uploads); }
  if (d.notes)       document.getElementById('notes-area').value = d.notes;
  if (d.last_activity) renderTicker(d.last_activity);
  if (d.routing_stats) renderProviderNodesFromStats(d.routing_stats);
  if (d.tasks !== undefined) renderTasks(d.tasks);
}

// ═══════════════════════════════════════════════════════
//  PANEL 1: SYSTEM METRICS
// ═══════════════════════════════════════════════════════
function renderSystemMetrics(d) {
  const cpu = d.cpu_percent || 0;
  const ram = d.memory_percent || 0;
  const swap = d.swap_percent || 0;
  const disks = d.disks || [];

  setGauge('cpu-gauge', cpu);
  setGauge('ram-gauge', ram);
  setGauge('swap-gauge', swap);

  document.getElementById('cpu-pct').textContent = cpu.toFixed(0) + '%';
  document.getElementById('cpu-pct').className = 'gauge-center ' + getMetricClass(cpu);
  document.getElementById('ram-pct').textContent = ram.toFixed(0) + '%';
  document.getElementById('ram-pct').className = 'gauge-center ' + getMetricClass(ram);
  document.getElementById('swap-pct').textContent = swap.toFixed(0) + '%';
  document.getElementById('swap-pct').className = 'gauge-center ' + getMetricClass(swap);

  if (disks.length > 0) {
    setGauge('disk0-gauge', disks[0].percent || 0);
    document.getElementById('disk0-pct').textContent = (disks[0].percent || 0).toFixed(0) + '%';
    document.getElementById('disk0-pct').className = 'gauge-center ' + getMetricClass(disks[0].percent || 0);
    document.getElementById('disk0-label').textContent = (disks[0].mountpoint || 'DISK').slice(0,6);
  }

  // Network
  if (d.network) {
    document.getElementById('net-up').textContent = fmtBytes(d.network.bytes_sent_per_sec) + '/s';
    document.getElementById('net-down').textContent = fmtBytes(d.network.bytes_recv_per_sec) + '/s';
  }
  document.getElementById('ram-used-str').textContent = fmtBytes(d.memory_used);
  document.getElementById('ram-total-str').textContent = fmtBytes(d.memory_total);

  // Multi-disk list
  const diskList = document.getElementById('disk-list');
  diskList.innerHTML = '';
  for (const disk of (disks || []).slice(0, 3)) {
    const el = document.createElement('div');
    el.className = 'disk-row';
    el.innerHTML = `
      <div class="disk-info">
        <span style="color:var(--text-dim)">${disk.mountpoint || disk.device}</span>
        <span style="color:${getMetricColor(disk.percent)}">${fmtBytes(disk.used)} / ${fmtBytes(disk.total)} (${disk.percent.toFixed(0)}%)</span>
      </div>
      <div class="disk-bar-bg"><div class="disk-bar" style="width:${disk.percent}%;background:${getMetricColor(disk.percent)}"></div></div>
    `;
    diskList.appendChild(el);
  }

  // Overall status badge
  const maxM = Math.max(cpu, ram);
  const badge = document.getElementById('syshealth-status');
  if (maxM >= 85) { badge.textContent = 'CRITICAL'; badge.style.color = 'var(--red)'; badge.style.borderColor = 'var(--red)44'; }
  else if (maxM >= 60) { badge.textContent = 'WARNING'; badge.style.color = 'var(--amber)'; badge.style.borderColor = 'var(--amber)44'; }
  else { badge.textContent = 'NOMINAL'; badge.style.color = 'var(--green)'; badge.style.borderColor = 'var(--green)44'; }

  // Update avatar sidebar
  document.getElementById('av-cpu').textContent = cpu.toFixed(0) + '%';
  document.getElementById('av-cpu').className = 'stat-val ' + getMetricClass(cpu);
  document.getElementById('av-ram').textContent = ram.toFixed(0) + '%';
  document.getElementById('av-ram').className = 'stat-val ' + getMetricClass(ram);

  // GPU section (Nvidia RTX data from nvidia-smi)
  const gpu = d.gpu;
  const gpuSection = document.getElementById('gpu-section');
  if (gpu && gpu.available) {
    gpuSection.style.display = '';
    document.getElementById('gpu-name').textContent = gpu.name || 'NVIDIA GPU';

    const utilBar  = document.getElementById('gpu-util-bar');
    const vramBar  = document.getElementById('gpu-vram-bar');
    const util     = gpu.util_pct || 0;
    const vramPct  = gpu.mem_pct || 0;

    utilBar.style.width = util + '%';
    // Red hot if util > 85%
    utilBar.className = 'gpu-bar-fill' + (util > 85 ? ' hot' : '');
    document.getElementById('gpu-util-val').textContent = util.toFixed(0) + '%';

    vramBar.style.width = vramPct + '%';
    vramBar.className = 'gpu-bar-fill' + (vramPct > 85 ? ' hot' : '');
    document.getElementById('gpu-vram-val').textContent = vramPct.toFixed(0) + '%';

    const tempC = gpu.temp_c || 0;
    const tempEl = document.getElementById('gpu-temp');
    tempEl.textContent = tempC + '°C';
    tempEl.style.color = tempC >= 85 ? 'var(--red)' : tempC >= 70 ? 'var(--amber)' : '#76b900';
    tempEl.style.textShadow = `0 0 6px ${tempC >= 85 ? 'var(--red)' : tempC >= 70 ? 'var(--amber)' : '#76b900'}`;

    document.getElementById('gpu-power').textContent = gpu.power_w != null ? gpu.power_w.toFixed(0) + 'W' : '—';
    document.getElementById('gpu-vram-used').textContent =
      gpu.mem_used_mb >= 1024 ? (gpu.mem_used_mb / 1024).toFixed(1) + 'G' : gpu.mem_used_mb.toFixed(0) + 'M';
    document.getElementById('gpu-vram-total').textContent =
      gpu.mem_total_mb >= 1024 ? (gpu.mem_total_mb / 1024).toFixed(1) + 'G' : gpu.mem_total_mb.toFixed(0) + 'M';
  } else if (gpu && !gpu.available) {
    gpuSection.style.display = 'none';
  }
}

// ═══════════════════════════════════════════════════════
//  PANEL 2: ROUTING
// ═══════════════════════════════════════════════════════
const PROVIDER_COLORS = {
  anthropic: 'var(--magenta)', openai: 'var(--cyan)',
  openrouter: 'var(--amber)', local: 'var(--green)', lmstudio: 'var(--green)'
};

function renderRouting(calls) {
  const list = document.getElementById('routing-list');
  list.innerHTML = '';
  for (const c of (calls || []).slice(0, 50)) {
    list.appendChild(makeRoutingEntry(c));
  }
  document.getElementById('routing-count').textContent = `${(calls || []).length} calls`;
}
function prependRoutingEntry(call) {
  const list = document.getElementById('routing-list');
  const entry = makeRoutingEntry(call);
  list.insertBefore(entry, list.firstChild);
  while (list.children.length > 50) list.removeChild(list.lastChild);
  const cnt = document.getElementById('routing-count');
  cnt.textContent = `${list.children.length} calls`;
}
function makeRoutingEntry(c) {
  const div = document.createElement('div');
  div.className = `routing-entry provider-${c.provider}`;
  const color = PROVIDER_COLORS[c.provider] || 'var(--text)';
  const model = c.actual_model || c.model_name || '—';
  const shortModel = model.split('/').pop().slice(0, 28);
  div.innerHTML = `
    <span class="routing-ts">${fmtTime(c.timestamp)}</span>
    <span class="routing-model" title="${model}" style="color:${color}">${shortModel}</span>
    <span class="routing-tokens">${((c.tokens_in||0)+(c.tokens_out||0)).toLocaleString()}t</span>
    <span class="routing-cost" style="color:${color}">${c.cost_usd === 0 ? 'FREE' : '$'+Number(c.cost_usd).toFixed(4)}</span>
  `;
  return div;
}

// ═══════════════════════════════════════════════════════
//  PANEL 3: PROVIDER NODES
// ═══════════════════════════════════════════════════════
function renderProviderNodesFromStats(stats) {
  renderProviderNodes(Object.entries(stats).map(([name, s]) => ({
    name, ...s,
    active: true,
    color: PROVIDER_COLORS[name] || 'var(--text)',
    cost_today: s.cost_today || 0,
    calls_today: s.calls_today || 0,
  })));
}
function renderProviderNodes(providers) {
  const nodeMap = {
    openrouter: { cost: 'pn-or-cost', calls: 'pn-or-calls', node: 'pnode-openrouter' },
    openai:     { cost: 'pn-oa-cost', calls: 'pn-oa-calls', node: 'pnode-openai'     },
    anthropic:  { cost: 'pn-an-cost', calls: 'pn-an-calls', node: 'pnode-anthropic'  },
    local:      { cost: 'pn-lc-cost', calls: 'pn-lc-calls', node: 'pnode-local'      },
  };
  let activeProvider = null;
  let latestTs = null;
  for (const p of (providers || [])) {
    const m = nodeMap[p.name];
    if (!m) continue;
    const node = document.getElementById(m.node);
    const costEl = document.getElementById(m.cost);
    const callsEl = document.getElementById(m.calls);
    if (!node) continue;
    if (p.active) {
      node.classList.add('active');
      node.classList.remove('pnode-inactive');
      // Find most recently active provider
      if (!latestTs || (p.last_call && p.last_call > latestTs)) {
        latestTs = p.last_call;
        activeProvider = p.name.toUpperCase();
      }
    } else {
      node.classList.remove('active');
      node.classList.add('pnode-inactive');
    }
    if (costEl) costEl.textContent = p.name === 'local' ? 'FREE' : '$' + Number(p.cost_today || 0).toFixed(4);
    if (callsEl) callsEl.textContent = `${p.calls_today || 0} calls`;
    // Update header badges
    const hdrBadge = document.getElementById(`hdr-${p.name}`);
    if (hdrBadge) {
      hdrBadge.style.opacity = p.active ? '1' : '0.4';
    }
  }
  if (activeProvider) {
    document.getElementById('rc-active').textContent = activeProvider;
    document.getElementById('active-provider').textContent = activeProvider;
  }
}

// ═══════════════════════════════════════════════════════
//  PANEL 4: BUDGET
// ═══════════════════════════════════════════════════════
function renderBudget(d) {
  if (!d) return;
  const pct = d.percent_used || 0;
  const circ = 364.4;
  const offset = circ - (circ * Math.min(100, pct) / 100);
  const gaugeFill = document.getElementById('budget-gauge-fill');
  gaugeFill.style.strokeDashoffset = offset;
  gaugeFill.style.stroke = getMetricColor(pct);

  document.getElementById('budget-pct').textContent = pct.toFixed(0) + '%';
  document.getElementById('budget-pct').style.color = getMetricColor(pct);
  document.getElementById('budget-spent').textContent = '$' + (d.total_spent || 0).toFixed(2);
  document.getElementById('budget-limit').textContent = '$' + (d.monthly_limit || 60).toFixed(2);
  document.getElementById('budget-remaining').textContent = '$' + (d.remaining || 0).toFixed(2);
  document.getElementById('budget-remaining').className = 'budget-row-val ' + getMetricClass(pct);
  document.getElementById('budget-daily').textContent = '$' + (d.daily_spent || 0).toFixed(4);
  document.getElementById('budget-burn').textContent = '$' + (d.daily_burn_rate || 0).toFixed(4);
  document.getElementById('budget-projected').textContent = '$' + (d.projected_month_end || 0).toFixed(2);

  // Status badge
  const badge = document.getElementById('budget-status-badge');
  if (pct >= 85) { badge.textContent = 'CRITICAL'; badge.style.color = 'var(--red)'; badge.style.borderColor = 'var(--red)44'; }
  else if (pct >= 60) { badge.textContent = 'WARNING'; badge.style.color = 'var(--amber)'; badge.style.borderColor = 'var(--amber)44'; }
  else { badge.textContent = 'NOMINAL'; badge.style.color = 'var(--green)'; badge.style.borderColor = 'var(--green)44'; }

  // Avatar sidebar
  document.getElementById('av-budget').textContent = `$${(d.total_spent||0).toFixed(2)} / $${(d.monthly_limit||60).toFixed(0)}`;
  document.getElementById('av-budget').className = 'stat-val ' + getMetricClass(pct);

  // Per-provider breakdown
  const provList = document.getElementById('budget-providers');
  provList.innerHTML = '';
  const byP = d.by_provider || {};
  const total = d.total_spent || 1;
  for (const [name, spent] of Object.entries(byP)) {
    const pPct = (spent / (d.monthly_limit || 60)) * 100;
    const color = PROVIDER_COLORS[name] || 'var(--text)';
    const el = document.createElement('div');
    el.className = 'budget-provider-row';
    el.innerHTML = `
      <div class="budget-provider-info">
        <span style="color:${color}">${name.toUpperCase()}</span>
        <span style="color:${color}">$${spent.toFixed(4)}</span>
      </div>
      <div class="bpr-bar-bg"><div class="bpr-bar" style="width:${Math.min(100,pPct)}%;background:${color}"></div></div>
    `;
    provList.appendChild(el);
  }
}

// ═══════════════════════════════════════════════════════
//  PANEL 5: CRON JOBS
// ═══════════════════════════════════════════════════════
function renderCrons(jobs) {
  const list = document.getElementById('cron-list');
  list.innerHTML = '';
  document.getElementById('cron-count').textContent = `${(jobs||[]).length} jobs`;
  for (const job of (jobs || [])) {
    const div = document.createElement('div');
    div.className = 'cron-row' + (job.last_status === 'FAILED' ? ' error-border' : '');
    const statusClass = {
      SUCCESS: 'badge-success', RUNNING: 'badge-running',
      FAILED: 'badge-failed', PENDING: 'badge-pending'
    }[job.last_status] || 'badge-pending';
    div.innerHTML = `
      <div class="cron-main">
        <div class="cron-name">${job.name}</div>
        <div class="cron-schedule">${job.schedule} · ${job.description || ''}</div>
        <div class="cron-last">Last: ${fmtRelTime(job.last_run)} · Next: ${fmtRelTime(job.next_run)} · Runs: ${job.run_count || 0}</div>
      </div>
      <span class="cron-badge ${statusClass}">${job.last_status || 'PENDING'}</span>
      <button class="cron-trigger" onclick="triggerCron('${job.name}')">▶ RUN</button>
    `;
    list.appendChild(div);
  }
}
async function triggerCron(name) {
  try {
    const r = await fetch(`/api/crons/${name}/trigger`, { method: 'POST' });
    const d = await r.json();
    showCmdOutput(`Triggered: ${name} — ${d.status}`);
  } catch(e) {
    showCmdOutput(`Error triggering ${name}: ${e.message}`, true);
  }
}

// ═══════════════════════════════════════════════════════
//  PANEL 6: AGENTS
// ═══════════════════════════════════════════════════════
function renderAgents(agents) {
  const list = document.getElementById('agent-list');
  list.innerHTML = '';
  document.getElementById('agent-count').textContent = `${(agents||[]).length} agents`;
  document.getElementById('av-agents').textContent = (agents||[]).length;
  for (const agent of (agents || [])) {
    const div = document.createElement('div');
    div.className = `agent-row status-${agent.status}`;
    div.setAttribute('data-agent', agent.name);
    const dotClass = { idle:'dot-idle', running:'dot-running', error:'dot-error' }[agent.status] || 'dot-idle';
    div.innerHTML = `
      <div class="agent-status-dot ${dotClass}"></div>
      <div class="agent-info">
        <div class="agent-name">${agent.display_name || agent.name}</div>
        <div class="agent-action" title="${agent.last_action||''}">${agent.last_action || '—'}</div>
      </div>
      <div class="agent-ts">${fmtRelTime(agent.last_active)}</div>
      <div class="agent-expand">▸</div>
    `;
    const logDiv = document.createElement('div');
    logDiv.className = 'agent-logs-popup';
    logDiv.id = `agent-logs-${agent.name}`;
    div.appendChild(logDiv);
    div.addEventListener('click', () => toggleAgentLogs(agent.name, div, logDiv));
    list.appendChild(div);
  }
}
async function toggleAgentLogs(name, row, logDiv) {
  const isOpen = logDiv.classList.contains('open');
  // Close all others
  document.querySelectorAll('.agent-logs-popup.open').forEach(el => el.classList.remove('open'));
  document.querySelectorAll('.agent-expand').forEach(el => el.textContent = '▸');
  if (!isOpen) {
    try {
      const r = await fetch(`/api/agents/${name}/logs?limit=20`);
      const logs = await r.json();
      logDiv.innerHTML = logs.slice(0,20).map(l =>
        `<div class="agent-log-line"><span style="color:var(--text-dim)">${fmtTime(l.timestamp)}</span> <span class="level-${l.level}">[${l.level}]</span> ${l.message}</div>`
      ).join('') || '<div class="agent-log-line c-dim">No logs found.</div>';
      logDiv.classList.add('open');
      row.querySelector('.agent-expand').textContent = '▾';
    } catch(e) {
      logDiv.innerHTML = `<div class="agent-log-line c-red">Error loading logs</div>`;
      logDiv.classList.add('open');
    }
  }
}
function updateAvatarStats(agents) {
  document.getElementById('av-agents').textContent = (agents||[]).length;
  const running = (agents||[]).filter(a => a.status === 'running').length;
  document.getElementById('av-agents').style.color = running > 0 ? 'var(--cyan)' : 'var(--text)';
}

// ═══════════════════════════════════════════════════════
//  PANEL 7: LOGS
// ═══════════════════════════════════════════════════════
function renderLogs(logs) {
  allLogs = (logs || []).slice().reverse(); // oldest first for display
  const stream = document.getElementById('log-stream');
  stream.innerHTML = '';
  const levelFilter = document.getElementById('log-level-filter').value;
  const agentFilter = document.getElementById('log-agent-filter').value.toLowerCase();
  for (const log of allLogs.slice(-100)) {
    if (levelFilter && log.level !== levelFilter) continue;
    if (agentFilter && !log.agent_name.toLowerCase().includes(agentFilter)) continue;
    stream.appendChild(makeLogEntry(log));
  }
  if (logsAutoScroll) stream.scrollTop = stream.scrollHeight;
}
function addLogEntry(log) {
  if (logsPaused) { allLogs.push(log); return; }
  const levelFilter = document.getElementById('log-level-filter').value;
  const agentFilter = document.getElementById('log-agent-filter').value.toLowerCase();
  if (levelFilter && log.level !== levelFilter) { allLogs.push(log); return; }
  if (agentFilter && !log.agent_name.toLowerCase().includes(agentFilter)) { allLogs.push(log); return; }
  allLogs.push(log);
  const stream = document.getElementById('log-stream');
  stream.appendChild(makeLogEntry(log));
  while (stream.children.length > 200) stream.removeChild(stream.firstChild);
  if (logsAutoScroll) stream.scrollTop = stream.scrollHeight;
}
function makeLogEntry(log) {
  const div = document.createElement('div');
  div.className = `log-entry`;
  div.innerHTML = `
    <span class="log-ts">${fmtTime(log.timestamp)}</span>
    <span class="log-agent">${log.agent_name}</span>
    <span class="log-msg level-${log.level}">[${log.level}] ${log.message}</span>
  `;
  return div;
}
function applyLogFilters() { renderLogs(allLogs.slice().reverse()); }
function toggleLogPause() {
  logsPaused = !logsPaused;
  const btn = document.getElementById('log-pause-btn');
  btn.textContent = logsPaused ? '▶ RESUME' : '⏸ PAUSE';
  btn.classList.toggle('active', !logsPaused);
  if (!logsPaused) renderLogs(allLogs.slice().reverse());
}
function toggleLogScroll() {
  logsAutoScroll = !logsAutoScroll;
  const btn = document.querySelectorAll('.log-btn')[1];
  btn.classList.toggle('active', logsAutoScroll);
}

// ═══════════════════════════════════════════════════════
//  PANEL 8: LM STUDIO
// ═══════════════════════════════════════════════════════
let _lmCurrentModel = null;

function renderLMStudio(d) {
  const dot = document.getElementById('lm-dot');
  const badge = document.getElementById('lm-badge');
  const model = document.getElementById('lm-model');
  const checked = document.getElementById('lm-checked');
  const ejectBtn = document.getElementById('lm-eject-btn');
  if (d.online) {
    dot.className = 'lm-indicator lm-online';
    badge.textContent = 'ONLINE'; badge.style.color = 'var(--green)'; badge.style.borderColor = 'var(--green)44';
    _lmCurrentModel = d.model || null;
    model.textContent = d.model || 'Model loaded';
    if (ejectBtn) ejectBtn.disabled = false;
    document.getElementById('av-lm').textContent = 'ONLINE';
    document.getElementById('av-lm').className = 'stat-val c-green';
    // Show model list
    const list = document.getElementById('lm-models-list');
    if (list && d.model) {
      list.innerHTML = `<div style="background:#0a1020;border:1px solid var(--green)33;border-radius:3px;padding:3px 8px;font-size:9px;color:var(--green)">◉ ${d.model}</div>`;
    }
  } else {
    dot.className = 'lm-indicator lm-offline';
    badge.textContent = 'OFFLINE'; badge.style.color = 'var(--red)'; badge.style.borderColor = 'var(--red)44';
    _lmCurrentModel = null;
    model.textContent = 'No model loaded';
    if (ejectBtn) ejectBtn.disabled = true;
    document.getElementById('av-lm').textContent = 'OFFLINE';
    document.getElementById('av-lm').className = 'stat-val c-red';
    const list = document.getElementById('lm-models-list');
    if (list) list.innerHTML = '';
  }
  checked.textContent = fmtTime(d.checked_at) || '—';
}

async function lmRefresh() {
  try {
    const r = await fetch('/api/lmstudio');
    if (r.ok) { const d = await r.json(); renderLMStudio(d); }
  } catch(e) {}
}

async function lmEject() {
  if (!_lmCurrentModel) return;
  const btn = document.getElementById('lm-eject-btn');
  if (btn) { btn.textContent = '⟳ EJECTING'; btn.disabled = true; }
  try {
    // Try LM Studio's model unload endpoint
    const lmBase = 'http://localhost:1234';
    // Attempt DELETE on the OpenAI-compatible models endpoint
    const r = await fetch(`${lmBase}/v1/models/${encodeURIComponent(_lmCurrentModel)}`, { method: 'DELETE' });
    await lmRefresh();
  } catch(e) {
    // If unreachable, just refresh status
    await lmRefresh();
  }
  if (btn) btn.textContent = '⏏ EJECT';
}

// ═══════════════════════════════════════════════════════
//  PANEL 9: TELEGRAM
// ═══════════════════════════════════════════════════════
function renderTelegram(d) {
  const dot = document.getElementById('tg-dot');
  const badge = document.getElementById('tg-badge');
  const status = document.getElementById('tg-status');
  if (d.connected) {
    dot.className = 'tg-dot connected';
    badge.textContent = 'LIVE'; badge.style.color = 'var(--green)'; badge.style.borderColor = 'var(--green)44';
    status.textContent = 'CONNECTED'; status.className = 'tg-status-text c-green';
    document.getElementById('av-tg').textContent = 'LIVE';
    document.getElementById('av-tg').className = 'stat-val c-green';
  } else {
    dot.className = 'tg-dot';
    badge.textContent = 'OFFLINE'; badge.style.color = 'var(--red)'; badge.style.borderColor = 'var(--red)44';
    status.textContent = 'DISCONNECTED'; status.className = 'tg-status-text c-red';
    document.getElementById('av-tg').textContent = 'OFFLINE';
    document.getElementById('av-tg').className = 'stat-val c-red';
  }
  document.getElementById('tg-last-msg').textContent = fmtRelTime(d.last_message) || '—';
  document.getElementById('tg-count').textContent = d.messages_today || 0;
}

// ═══════════════════════════════════════════════════════
//  PANEL 10: FILE UPLOAD
// ═══════════════════════════════════════════════════════
const dropZone = document.getElementById('drop-zone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  uploadFiles([...e.dataTransfer.files]);
});
function handleFileSelect(e) { uploadFiles([...e.target.files]); }

async function uploadFiles(files) {
  for (const file of files) {
    const formData = new FormData();
    formData.append('file', file);
    const pw = document.getElementById('upload-progress-wrap');
    const pb = document.getElementById('upload-progress-bar');
    pw.style.display = 'block'; pb.style.width = '0%';
    // Simulate progress
    let prog = 0;
    const progInterval = setInterval(() => {
      prog = Math.min(90, prog + 10);
      pb.style.width = prog + '%';
    }, 150);
    try {
      const r = await fetch('/api/upload', { method: 'POST', body: formData });
      clearInterval(progInterval);
      pb.style.width = '100%';
      if (r.ok) {
        const data = await r.json();
        allUploads.unshift(data);
        renderUploads(allUploads.slice(0, 10));
      }
    } catch(e) {
      clearInterval(progInterval);
    }
    setTimeout(() => { pw.style.display = 'none'; pb.style.width = '0%'; }, 1000);
  }
}

function renderUploads(uploads) {
  const list = document.getElementById('upload-list');
  list.innerHTML = '';
  document.getElementById('upload-count').textContent = `${(uploads||[]).length} files`;
  for (const u of (uploads || []).slice(0, 10)) {
    const el = document.createElement('div');
    el.className = 'upload-item';
    el.innerHTML = `
      <span class="upload-name" title="${u.original_name}">${u.original_name}</span>
      <span class="upload-meta">${fmtBytes(u.size)} · ${fmtRelTime(u.timestamp)}</span>
    `;
    list.appendChild(el);
  }
}

// ═══════════════════════════════════════════════════════
//  PANEL 11: NOTES (manual save — no autosave)
// ═══════════════════════════════════════════════════════
document.getElementById('notes-area').addEventListener('input', () => {
  const status = document.getElementById('notes-status');
  status.textContent = 'unsaved';
  status.className = 'notes-unsaved';
});
async function saveNotes() {
  const content = document.getElementById('notes-area').value;
  const btn = document.getElementById('notes-save-btn');
  const status = document.getElementById('notes-status');
  if (btn) { btn.textContent = '⟳ SAVING'; btn.disabled = true; btn.className = 'notes-save-btn saving'; }
  try {
    await fetch('/api/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, export_to_import: true })
    });
    if (status) { status.textContent = 'saved ✓'; status.className = ''; status.style.color = 'var(--green)'; }
    if (btn) { btn.textContent = '💾 SAVE'; btn.disabled = false; btn.className = 'notes-save-btn'; }
    setTimeout(() => {
      if (status) { status.textContent = 'ready'; status.className = ''; status.style.color = 'var(--text-dim)'; }
    }, 3000);
  } catch(e) {
    if (status) { status.textContent = 'save failed!'; status.style.color = 'var(--red)'; }
    if (btn) { btn.textContent = '💾 SAVE'; btn.disabled = false; btn.className = 'notes-save-btn'; }
  }
}

// ═══════════════════════════════════════════════════════
//  QUICK LAUNCH
// ═══════════════════════════════════════════════════════
function renderQuickLaunch(buttons) {
  const container = document.getElementById('ql-buttons');
  container.innerHTML = '';
  container.style.display = 'flex';
  container.style.gap = '8px';
  for (const btn of (buttons || [])) {
    const el = document.createElement('button');
    el.className = 'ql-btn';
    el.textContent = btn.label;
    el.style.color = btn.color || 'var(--cyan)';
    el.style.borderColor = (btn.color || 'var(--cyan)') + '66';
    el.onclick = () => executeCommand(btn.command);
    container.appendChild(el);
  }
}

// ═══════════════════════════════════════════════════════
//  AVATAR
// ═══════════════════════════════════════════════════════
const MOOD_COLORS = {
  idle:'var(--cyan)', happy:'var(--green)', thinking:'var(--purple)',
  alert:'var(--amber)', error:'var(--red)', bored:'var(--text-dim)'
};
function renderAvatar(d) {
  if (!d) return;
  // Update mood display
  const mood = d.mood || 'idle';
  document.getElementById('av-mood').textContent = mood.toUpperCase();
  document.getElementById('av-mood').style.color = MOOD_COLORS[mood] || 'var(--cyan)';
  // Sync the panel-header badge too
  const moodBadge = document.getElementById('av-mood-badge');
  if (moodBadge) {
    moodBadge.textContent = mood.toUpperCase();
    moodBadge.style.color = MOOD_COLORS[mood] || 'var(--cyan)';
  }
  // Update ring colors based on mood
  document.querySelectorAll('.hud-ring-1').forEach(r => r.style.borderTopColor = d.color || 'var(--cyan)');
  // Mood bar
  const moodBar = document.getElementById('mood-bar');
  moodBar.style.background = d.color || 'var(--cyan)';
  const moodPcts = { happy:100, idle:70, thinking:85, alert:50, error:20, bored:30 };
  moodBar.style.width = (moodPcts[mood] || 70) + '%';
  // Avatar image crossfade
  if (d.image_url) {
    const next = d.image_url;
    if (!avatarInitialized) {
      // First load: show imgA directly
      imgA.src = next;
      imgA.onload = () => { imgA.style.opacity = '1'; };
      imgA.onerror = () => {};
      avatarActive = 'a';
      avatarInitialized = true;
    } else if (avatarActive === 'a') {
      imgB.src = next;
      imgB.style.opacity = '0';
      imgB.onload = () => {
        imgA.style.transition = 'opacity 1.2s';
        imgB.style.transition = 'opacity 1.2s';
        imgA.style.opacity = '0';
        imgB.style.opacity = '1';
        avatarActive = 'b';
      };
    } else {
      imgA.src = next;
      imgA.style.opacity = '0';
      imgA.onload = () => {
        imgA.style.transition = 'opacity 1.2s';
        imgB.style.transition = 'opacity 1.2s';
        imgB.style.opacity = '0';
        imgA.style.opacity = '1';
        avatarActive = 'a';
      };
    }
  }
}

// ═══════════════════════════════════════════════════════
//  ACTIVITY TICKER
// ═══════════════════════════════════════════════════════
function renderTicker(last) {
  if (!last) return;
  const inner = document.getElementById('ticker-inner');
  const ts = fmtTime(last.timestamp);
  const agent = last.agent_name || 'system';
  const msg = last.message || '';
  const entry = `<span class="ticker-ts">[${ts}]</span> <span class="ticker-agent">${agent.toUpperCase()}</span> <span class="ticker-arrow">→</span> <span class="ticker-msg">${msg}</span>`;
  inner.innerHTML = `<span>${entry}</span><span>${entry}</span>`;
}

// ═══════════════════════════════════════════════════════
//  COMMAND BAR
// ═══════════════════════════════════════════════════════
const cmdInput = document.getElementById('cmd-input');
const cmdOutput = document.getElementById('cmd-output');
const tabComplete = document.getElementById('tab-complete');

cmdInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    const cmd = cmdInput.value.trim();
    if (!cmd) return;
    cmdHistory.unshift(cmd);
    cmdHistoryIdx = -1;
    cmdInput.value = '';
    tabComplete.classList.remove('visible');
    await executeCommand(cmd);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    cmdHistoryIdx = Math.min(cmdHistoryIdx + 1, cmdHistory.length - 1);
    cmdInput.value = cmdHistory[cmdHistoryIdx] || '';
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    cmdHistoryIdx = Math.max(cmdHistoryIdx - 1, -1);
    cmdInput.value = cmdHistoryIdx >= 0 ? cmdHistory[cmdHistoryIdx] : '';
  } else if (e.key === 'Tab') {
    e.preventDefault();
    showTabComplete(cmdInput.value);
  } else if (e.key === 'Escape') {
    tabComplete.classList.remove('visible');
  }
});

function showTabComplete(partial) {
  const parts = partial.split(' ');
  const verb = parts[0].toLowerCase();
  let options = [];
  if (parts.length <= 1) {
    options = ['trigger', 'restart', 'run', 'clear', 'reload', 'set'];
  } else if (['trigger', 'restart', 'run'].includes(verb)) {
    if (verb === 'trigger') options = allCrons.map(c => c.name);
    else options = allAgents.map(a => a.name);
  }
  const prefix = parts.length > 1 ? parts[parts.length - 1] : parts[0];
  const filtered = options.filter(o => o.toLowerCase().startsWith(prefix.toLowerCase()));
  if (!filtered.length) { tabComplete.classList.remove('visible'); return; }
  tabComplete.innerHTML = filtered.map(o => `<div class="tab-option" onclick="selectTabOption('${o}')">${o}</div>`).join('');
  tabComplete.classList.add('visible');
}

function selectTabOption(val) {
  const parts = cmdInput.value.split(' ');
  parts[parts.length - 1] = val;
  cmdInput.value = parts.join(' ') + ' ';
  tabComplete.classList.remove('visible');
  cmdInput.focus();
}

async function executeCommand(cmd) {
  try {
    const r = await fetch('/api/command', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command: cmd })
    });
    const d = await r.json();
    showCmdOutput(`> ${cmd}\n${d.output || '✓ Done'}`);
  } catch(e) {
    showCmdOutput(`> ${cmd}\nError: ${e.message}`, true);
  }
}

function showCmdOutput(text, isError = false) {
  cmdOutput.innerHTML = text.split('\n').map((line, i) =>
    `<div class="${i === 0 ? 'c-dim' : (isError ? 'cmd-error' : 'cmd-result')}">${line}</div>`
  ).join('');
  cmdOutput.classList.add('visible');
  clearTimeout(cmdOutput._timer);
  cmdOutput._timer = setTimeout(() => cmdOutput.classList.remove('visible'), 5000);
}

// ═══════════════════════════════════════════════════════
//  PANEL 13: AI CHAT (API key persisted per-provider in localStorage)
// ═══════════════════════════════════════════════════════
const CHAT_MODELS = {
  anthropic:  ['claude-opus-4-5','claude-sonnet-4-5','claude-3-5-sonnet-20241022','claude-3-5-haiku-20241022','claude-3-haiku-20240307'],
  openai:     ['gpt-4o','gpt-4o-mini','gpt-4-turbo','o1-preview','o1-mini'],
  openrouter: ['anthropic/claude-3.5-sonnet','anthropic/claude-3-haiku','openai/gpt-4o','openai/gpt-4o-mini','meta-llama/llama-3.1-70b-instruct','google/gemini-flash-1.5','mistralai/mistral-large','deepseek/deepseek-r1'],
};
let chatMessages = [];

function chatUpdateModels() {
  const provider = document.getElementById('chat-provider').value;
  const modelSel = document.getElementById('chat-model');
  modelSel.innerHTML = '';
  (CHAT_MODELS[provider] || []).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m; opt.textContent = m;
    modelSel.appendChild(opt);
  });
}
// Persist API key per-provider in localStorage
function chatSaveKey() {
  const provider = document.getElementById('chat-provider').value;
  const key = document.getElementById('chat-api-key').value.trim();
  if (key) localStorage.setItem(`cc-apikey-${provider}`, key);
  else localStorage.removeItem(`cc-apikey-${provider}`);
}
function chatLoadSavedKey() {
  const provider = document.getElementById('chat-provider').value;
  const saved = localStorage.getItem(`cc-apikey-${provider}`) || '';
  document.getElementById('chat-api-key').value = saved;
}

function appendChatMsg(role, text, isLoading = false) {
  const box = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `chat-msg chat-msg-${role}`;
  if (isLoading) div.id = 'chat-loading';
  const safe = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  div.innerHTML = `<span class="chat-msg-label">${role === 'user' ? 'YOU' : 'AI'}</span><span class="chat-msg-text">${safe}</span>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

async function sendChat() {
  const inputEl = document.getElementById('chat-input');
  const text = inputEl.value.trim();
  if (!text) return;
  const provider = document.getElementById('chat-provider').value;
  const model    = document.getElementById('chat-model').value;
  const badgeEl  = document.getElementById('chat-status-badge');

  inputEl.value = '';
  appendChatMsg('user', text);
  chatMessages.push({ role: 'user', content: text });

  const loadEl = appendChatMsg('assistant', '⟳ thinking...', true);
  if (badgeEl) { badgeEl.textContent = 'THINKING'; badgeEl.style.color = 'var(--amber)'; badgeEl.style.borderColor = 'var(--amber)44'; }

  try {
    const apiKey = (document.getElementById('chat-api-key')?.value || '').trim();
    const resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider, model, messages: chatMessages, api_key: apiKey || undefined })
    });
    const data = await resp.json();
    loadEl.remove();
    if (resp.ok && data.reply) {
      appendChatMsg('assistant', data.reply);
      chatMessages.push({ role: 'assistant', content: data.reply });
      if (badgeEl) { badgeEl.textContent = 'READY'; badgeEl.style.color = 'var(--magenta)'; badgeEl.style.borderColor = 'var(--magenta)44'; }
    } else {
      const errDiv = appendChatMsg('assistant', '⚠ ' + (data.detail || 'Unknown error'));
      errDiv.querySelector('.chat-msg-text').style.color = 'var(--red)';
      if (badgeEl) { badgeEl.textContent = 'ERROR'; badgeEl.style.color = 'var(--red)'; badgeEl.style.borderColor = 'var(--red)44'; }
    }
  } catch(e) {
    loadEl.remove();
    const errDiv = appendChatMsg('assistant', '⚠ Network error: ' + e.message);
    errDiv.querySelector('.chat-msg-text').style.color = 'var(--red)';
    if (badgeEl) { badgeEl.textContent = 'ERROR'; badgeEl.style.color = 'var(--red)'; badgeEl.style.borderColor = 'var(--red)44'; }
  }
}

function clearChat() {
  chatMessages = [];
  document.getElementById('chat-messages').innerHTML = '';
  const badgeEl = document.getElementById('chat-status-badge');
  if (badgeEl) { badgeEl.textContent = 'READY'; badgeEl.style.color = 'var(--magenta)'; badgeEl.style.borderColor = 'var(--magenta)44'; }
}

// ═══════════════════════════════════════════════════════
//  TASKS (TO-DO PANEL)
// ═══════════════════════════════════════════════════════
function renderTasks(tasks) {
  const list = document.getElementById('todo-list');
  if (!list) return;
  if (!tasks || tasks.length === 0) {
    list.innerHTML = '<div class="todo-empty">No task files in tasks/ folder</div>';
    return;
  }
  list.innerHTML = '';
  for (const task of tasks) {
    const div = document.createElement('div');
    div.className = 'todo-item' + (task.done ? ' todo-done' : '');
    const preview = (task.content || '').trim().slice(0, 120).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,' ');
    div.innerHTML = `
      <div class="todo-item-header">
        <span class="todo-item-title">${task.done ? '✓' : '▪'} ${task.title || task.filename}</span>
        <span class="todo-item-date">${task.modified_str ? task.modified_str.split(' ')[0] : ''}</span>
      </div>
      ${preview ? `<div class="todo-item-preview">${preview}</div>` : ''}
    `;
    list.appendChild(div);
  }
}
async function openTasksFolder() {
  try { await fetch('/api/tasks/open-folder'); } catch(e) {}
}

// ═══════════════════════════════════════════════════════
//  LAYOUT — CSS GRID (GridStack removed)
// ═══════════════════════════════════════════════════════
// All tile positioning is now pure CSS (see [data-gs-id] rules in <style>).
// No JavaScript needed for layout — tiles render instantly with zero artifacts.

function resetGridLayout() {
  // Layout is CSS — "reset" just reloads the page to clear any JS state
  window.location.reload();
}

// ═══════════════════════════════════════════════════════
//  CANVAS PARTICLE EFFECTS (energy lines background)
// ═══════════════════════════════════════════════════════
function initParticles() {
  // Mini particle canvas for the provider visualization
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:absolute;inset:0;pointer-events:none;opacity:0.4;z-index:1';
  document.getElementById('panel-providers').querySelector('.provider-viz').appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const particles = [];
  function resizeCanvas() {
    const parent = canvas.parentElement;
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
  }
  resizeCanvas();
  // Create particles along energy line paths
  const paths = [
    { start: [0.25, 0.2], end: [0.5, 0.5], color: '#ffaa00' },
    { start: [0.75, 0.2], end: [0.5, 0.5], color: '#00f0ff' },
    { start: [0.5, 0.9], end: [0.5, 0.5], color: '#ff00c8' },
  ];
  for (let i = 0; i < 30; i++) {
    const path = paths[i % paths.length];
    particles.push({
      path, t: Math.random(),
      speed: 0.003 + Math.random() * 0.004,
      size: 1 + Math.random() * 2,
    });
  }
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const p of particles) {
      p.t += p.speed;
      if (p.t > 1) p.t = 0;
      const x = p.path.start[0] + (p.path.end[0] - p.path.start[0]) * p.t;
      const y = p.path.start[1] + (p.path.end[1] - p.path.start[1]) * p.t;
      ctx.beginPath();
      ctx.arc(x * canvas.width, y * canvas.height, p.size, 0, Math.PI * 2);
      ctx.fillStyle = p.path.color + Math.floor(255 * (1 - Math.abs(p.t - 0.5) * 2)).toString(16).padStart(2,'0');
      ctx.fill();
    }
    requestAnimationFrame(animate);
  }
  animate();
}

// ═══════════════════════════════════════════════════════
//  API FALLBACK POLLING (if WS fails)
// ═══════════════════════════════════════════════════════
let fallbackInterval = null;
function startFallbackPolling() {
  if (fallbackInterval) return;
  fallbackInterval = setInterval(async () => {
    if (ws && ws.readyState === WebSocket.OPEN) { clearInterval(fallbackInterval); fallbackInterval = null; return; }
    try {
      const [metrics, budget, agents, routing] = await Promise.all([
        fetch('/api/system').then(r => r.json()),
        fetch('/api/budget').then(r => r.json()),
        fetch('/api/agents').then(r => r.json()),
        fetch('/api/routing').then(r => r.json()),
      ]);
      renderSystemMetrics(metrics);
      renderBudget(budget);
      renderAgents(agents);
      renderRouting(routing);
    } catch(e) {}
  }, 8000);
}

// ═══════════════════════════════════════════════════════
//  INITIAL DATA LOAD
// ═══════════════════════════════════════════════════════
async function loadInitialData() {
  // Load avatar immediately
  try {
    const r = await fetch('/api/avatar');
    if (r.ok) { const d = await r.json(); renderAvatar(d); }
  } catch(e) {}
  // Load tasks immediately
  try {
    const r = await fetch('/api/tasks');
    if (r.ok) { const d = await r.json(); renderTasks(d); }
  } catch(e) {}
}

// 30-second avatar cycle timer
setInterval(() => {
  fetch('/api/avatar/cycle', { method: 'POST' })
    .then(r => r.json())
    .then(d => renderAvatar(d))
    .catch(() => {});
}, 30000);

// ═══════════════════════════════════════════════════════
//  PANEL 14: GIPHY SEARCH
// ═══════════════════════════════════════════════════════
const GIPHY_DEMO_KEY = 'dc6zaTOxFJmzC'; // Giphy public demo key (rate limited)
let giphySelectedUrl = null;

async function giphySearch() {
  const q = document.getElementById('giphy-search-input').value.trim();
  if (!q) return;
  const apiKey = (document.getElementById('giphy-api-key').value.trim()) || GIPHY_DEMO_KEY;
  const btn = document.getElementById('giphy-search-btn');
  const badge = document.getElementById('giphy-badge');
  btn.textContent = '⟳'; btn.disabled = true;
  if (badge) badge.textContent = 'SEARCHING';

  try {
    const url = `https://api.giphy.com/v1/gifs/search?api_key=${apiKey}&q=${encodeURIComponent(q)}&limit=12&rating=pg-13&lang=en`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    const grid = document.getElementById('giphy-results');
    grid.innerHTML = '';
    const gifs = data.data || [];
    if (gifs.length === 0) {
      grid.innerHTML = '<div class="giphy-empty">No GIFs found. Try another search!</div>';
    } else {
      for (const gif of gifs.slice(0, 12)) {
        const thumb = gif.images?.fixed_width_small?.url || gif.images?.original?.url || '';
        const full  = gif.images?.original?.url || thumb;
        const img   = document.createElement('img');
        img.className = 'giphy-thumb';
        img.src = thumb;
        img.alt = gif.title || 'gif';
        img.title = gif.title || '';
        img.loading = 'lazy';
        img.onclick = () => giphySelect(full);
        grid.appendChild(img);
      }
    }
    if (badge) badge.textContent = `${gifs.length} FOUND`;
  } catch(e) {
    const grid = document.getElementById('giphy-results');
    grid.innerHTML = `<div class="giphy-empty" style="color:var(--red)">Error: ${e.message}<br><span style="font-size:8px">Check API key or try again</span></div>`;
    if (badge) badge.textContent = 'ERROR';
  }
  btn.textContent = '🔍'; btn.disabled = false;
}

function giphySelect(url) {
  giphySelectedUrl = url;
  const featured = document.getElementById('giphy-featured');
  featured.src = url;
  featured.style.display = 'block';
  const badge = document.getElementById('giphy-badge');
  if (badge) badge.textContent = 'LOADED ✓';
}

function giphyCopyUrl() {
  if (!giphySelectedUrl) return;
  try {
    navigator.clipboard.writeText(giphySelectedUrl);
    const badge = document.getElementById('giphy-badge');
    if (badge) { const prev = badge.textContent; badge.textContent = 'URL COPIED!'; setTimeout(() => badge.textContent = prev, 2000); }
  } catch(e) {}
}

function clearGiphy() {
  giphySelectedUrl = null;
  const featured = document.getElementById('giphy-featured');
  featured.src = ''; featured.style.display = 'none';
  document.getElementById('giphy-results').innerHTML = '<div class="giphy-empty">Search for GIFs above ↑<br><span style="color:var(--magenta);font-size:8px;margin-top:4px;display:block">ADHD MODE ENGAGED ⚡</span></div>';
  document.getElementById('giphy-search-input').value = '';
  const badge = document.getElementById('giphy-badge');
  if (badge) badge.textContent = 'BROWSE';
}

// ═══════════════════════════════════════════════════════
//  PANEL 15: MEDIA PASS-THROUGH PLAYER
// ═══════════════════════════════════════════════════════
let _mediaUrl = null;

function convertToEmbedUrl(rawUrl) {
  const url = rawUrl.trim();
  // YouTube watch?v=... or youtu.be/...
  const ytWatch = url.match(/[?&]v=([A-Za-z0-9_-]{11})/);
  if (ytWatch) return `https://www.youtube.com/embed/${ytWatch[1]}?autoplay=1&rel=0`;
  const ytShort = url.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
  if (ytShort) return `https://www.youtube.com/embed/${ytShort[1]}?autoplay=1&rel=0`;
  // YouTube live or channel link fallback
  if (url.includes('youtube.com/') && !url.includes('/embed/')) {
    // Pass through as-is but use nocookie domain
    return url.replace('www.youtube.com', 'www.youtube-nocookie.com');
  }
  // Twitch channel: twitch.tv/channelname → player embed
  const twitchCh = url.match(/twitch\.tv\/([a-zA-Z0-9_]+)\/?$/);
  if (twitchCh && twitchCh[1] !== 'videos' && twitchCh[1] !== 'directory') {
    return `https://player.twitch.tv/?channel=${twitchCh[1]}&parent=${location.hostname}&autoplay=false&muted=false`;
  }
  // Already an embed or player URL — use as-is
  return url;
}

function openInPlayer(rawUrl, title) {
  const embedUrl = convertToEmbedUrl(rawUrl);
  // If conversion failed for TikTok etc, open new tab instead
  if (rawUrl.includes('tiktok.com') && !rawUrl.includes('embed')) {
    window.open(rawUrl, '_blank');
    return;
  }
  document.getElementById('media-url-input').value = rawUrl;
  _loadMediaEmbed(embedUrl, title);
  // Smooth-scroll to media panel
  const el = document.querySelector('.grid-stack-item[data-gs-id="media"]');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function loadMediaFromInput() {
  const raw = document.getElementById('media-url-input').value.trim();
  if (!raw) return;
  const embed = convertToEmbedUrl(raw);
  _loadMediaEmbed(embed);
}

function _loadMediaEmbed(embedUrl, title) {
  const frame = document.getElementById('media-iframe');
  const placeholder = document.getElementById('media-placeholder');
  const badge = document.getElementById('media-badge');
  if (!frame) return;
  _mediaUrl = embedUrl;
  frame.src = embedUrl;
  frame.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';
  if (badge) badge.textContent = title ? title.toUpperCase().slice(0,16) : 'PLAYING';
}

function clearMedia() {
  const frame = document.getElementById('media-iframe');
  const placeholder = document.getElementById('media-placeholder');
  const badge = document.getElementById('media-badge');
  if (frame) { frame.src = 'about:blank'; frame.style.display = 'none'; }
  if (placeholder) placeholder.style.display = 'flex';
  if (badge) badge.textContent = 'STANDBY';
  _mediaUrl = null;
  const inp = document.getElementById('media-url-input');
  if (inp) inp.value = '';
}

// ═══════════════════════════════════════════════════════
//  BOOT
// ═══════════════════════════════════════════════════════
window.addEventListener('load', () => {
  chatUpdateModels();     // populate chat model dropdown
  chatLoadSavedKey();     // restore saved API key for current provider
  connectWS();
  initParticles();
  loadInitialData();
  setTimeout(startFallbackPolling, 5000);
});
</script>
</body>
</html>
